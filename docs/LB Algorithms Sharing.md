# Load Balance Algorithms

æˆ‘çš„LBç®—æ³•åˆ†äº«æ–‡æ¡£é‡Œå†™äº†å¾ˆå¤šç§ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œç°åœ¨éœ€è¦æŠŠå®ƒä»¬æ”¾åœ¨ä¸€èµ·å®ç°å¹¶è¿›è¡Œå¯¹æ¯”ã€‚
1. å®ç°å„ä¸ªä¸€è‡´æ€§å“ˆå¸Œç®—æ³•
2. è¿›è¡Œå®éªŒæµ‹è¯•ç®—æ³•
3. å¯¹ç»“æœè¿›è¡Œæ±‡æ€»å¹¶ç»˜åˆ¶å¯¹æ¯”å›¾åƒ
æˆ‘å®éªŒæƒ³è¦çŸ¥é“çš„æ˜¯ï¼š
1. å„ä¸ªç®—æ³•çš„å³°å‡å€¼æ¯”
2. å„ä¸ªç®—æ³•åœ¨æ·»åŠ äº†ä¸åŒçš„åç«¯æœåŠ¡å™¨æ•°é‡ä¹‹åï¼Œæ–°æ·»åŠ è¿æ¥æ—¶è¿›è¡Œè°ƒåº¦çš„æ—¶é—´
3. å„ä¸ªç®—æ³•åœ¨å·²æœ‰1000å°åç«¯æœåŠ¡å™¨æ•°é‡çš„æƒ…å†µä¸‹ï¼Œå¢åŠ å’Œåˆ é™¤ä¸åŒæ•°é‡çš„åç«¯æœåŠ¡å™¨ä¼šé€ æˆå¤šå°‘keyé‡æ˜ å°„

> å†™åœ¨æœ€å‰ï¼šLB ç®—æ³•çš„æ›´æ–°æ˜¯ä¸€ç›´åœ¨è€ƒè™‘å¦‚ä½•æ‰ç®—æ˜¯å…¬å¹³æ€§çš„é—®é¢˜ã€‚å®ƒæƒ³è®¨è®ºçš„æ˜¯åœ¨ä¸åŒå±‚é¢ï¼ˆè§’åº¦ï¼‰çš„å…¬å¹³æ€§å’Œä¸åŒåœºæ™¯ä¸‹çš„å…¬å¹³æ€§ï¼Œä¾‹å¦‚å½“ä½ è€ƒè™‘åˆ°ä» LB è¿˜æ˜¯åç«¯æœåŠ¡å™¨çš„è§’åº¦è€ƒè™‘é—®é¢˜ï¼Œäº¦æˆ–æ˜¯ä¸åŒæœåŠ¡å™¨ä¹‹é—´çš„æ€§èƒ½å·®å¼‚ã€è¿æ¥çŠ¶æ€çš„å·®å¼‚ï¼Œåˆæˆ–æ˜¯åœ¨åç«¯çš„æ‰©ç¼©å®¹åœºæ™¯ã€è·¨ä¸åŒåœ°åŸŸåœºæ™¯ï¼Ÿç­‰
>
> åº”è¯¥è¯´ LB ç®—æ³•ä¹‹é—´æ²¡æœ‰ç»å¯¹çš„å¥½åä¹‹åˆ†ï¼Œè€Œæ˜¯æ ¹æ®åœºæ™¯éœ€æ±‚é€‰æ‹©æœ€åˆé€‚çš„æ–¹æ³•
>
> æ¯”è¾ƒå¥½çš„æ–¹å¼æ˜¯è¯„ä¼°å“ªå°æœåŠ¡å™¨æœ‰èƒ½åŠ›ç»§ç»­åŠæ—¶çš„å¤„ç†è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›æ–¹å¼æˆ–æŒ‡æ ‡æ¥è¯„åˆ¤è°å½“å‰æ›´æœ‰èƒ½åŠ›æˆ–æ›´èƒ½åŠæ—¶çš„è¿›è¡Œå¤„ç†ï¼Œå°†ä¸‹ä¸€ä¸ªæ–°è¿æ¥äº¤ç»™å®ƒã€‚æ€ä¹ˆåˆ¤æ–­è°ç°åœ¨æ›´æœ‰èƒ½åŠ›æˆ–æ›´èƒ½åŠæ—¶å¤„ç†å‘¢ï¼Ÿ
>
> * å½“å‰ CPU è´Ÿè½½
> * å·²æœ‰çš„è¿æ¥æ•°é‡
> * ç½‘ç»œè¿æ¥ç©ºé—²
> * [å‘æ•£] æœåŠ¡å™¨ä¸»åŠ¨æå‡ºæƒ³è¦æ¥æ”¶ (æˆ–ä»»åŠ¡çªƒå–)

## åŸºç¡€å…¬å¹³ï¼ˆé›¨éœ²å‡æ²¾ï¼‰

* RR (Round Robinï¼Œè½®è¯¢)

æŒ‰ç…§æ‰€æœ‰ rs ç»„æˆçš„é˜Ÿåˆ—ï¼Œéå†çš„é€‰æ‹©ä¸‹ä¸€ä¸ªè¿˜æœªè°ƒåº¦çš„ RSï¼Œä¿è¯äº†æœ€åŸºç¡€çš„è°ƒåº¦å…¬å¹³ä½†ä¸è€ƒè™‘ä»»ä½•å¯èƒ½çš„å·®å¼‚

## ä»æœåŠ¡å™¨é—´å­˜åœ¨å·®å¼‚çš„è§’åº¦

åç«¯æœåŠ¡å™¨æœ¬èº«åœ¨å¤„ç†æ—¶å¿…å®šæœ‰ä¸€äº›æ€§èƒ½å·®å¼‚ã€‚ç›¸æ¯”äºæ”¶é›† RS è¿˜æœ‰å¤šå°‘ä»»åŠ¡è¦å¤„ç†ï¼Œæˆ–æ˜¯æŒç»­ç»Ÿè®¡æ‰€æœ‰ RS çš„ CPU å ç”¨ç‡ï¼Œè‚¯å®šæ˜¯ç›´æ¥ç”± RS æ€§èƒ½æ¥å®šä¹‰æƒé‡æœ€ä¸ºç®€å•é«˜æ•ˆ

æƒé‡éœ€è¦åŠ¨æ€å¯è°ƒã€‚å¯¹ä¸šåŠ¡æ¥è¯´ï¼Œæ–°ä¸Šçº¿çš„ RS å¯ä»¥è‡ªè¡ŒåŠ¨æ€çš„ç”±ä½åˆ°é«˜çš„ç¼“æ…¢ä¿®æ”¹å…¶æƒé‡æ¥å®ç°é¢„çƒ­ç­‰ä¸€äº›éœ€æ±‚ï¼Œæˆ–æ˜¯æ–°å¢ RS çš„æƒé‡ç›¸åº”æ‹‰é«˜æ¥ä¿è¯å®ƒåœ¨å¼€å§‹æ—¶æœ‰æ›´å¤šçš„ä»»åŠ¡å»å¤„ç†æ¥å¿«é€Ÿåˆ†æ‹…å…¶ä»– RS çš„å‹åŠ›ç­‰

### (I)WRR

å¯¹æ¯ä¸ª RS éƒ½ç›¸åº”çš„é…ç½®å…¶æƒé‡ï¼Œä¼˜å…ˆé€‰æ‹©å½“å‰æƒé‡æœ€é«˜çš„ RS è¿›è¡Œè°ƒåº¦

* WRR (Weighted Round Robinï¼ŒåŠ æƒè½®è¯¢)

ä¼ ç»Ÿçš„ WRR æ˜¯ä»¥é˜Ÿåˆ—çš„å±‚é¢çœ‹å¾…ï¼Œç›¸å½“äºä¸ºæ¯ä¸ª RS å¼€è¾Ÿä¸€ä¸ªå‘é€é˜Ÿåˆ—ï¼Œæ‰¹é‡çš„å°†ä¸æƒé‡æ•°é‡ç›¸å½“çš„åŒ…ç›´æ¥è½¬å‘ç»™é€‰æ‹©çš„ RSã€‚å®ƒçš„å¥½å¤„ä¹Ÿæ˜¯å¯ä»¥æ‰¹é‡å¤„ç†ï¼Œä½†æ˜¯è¿™å¯¹ LB æ¥è¯´æ²¡æœ‰å¿…è¦

ç®€å•çš„æ”¹è¿›æ˜¯ä»¥å•ä¸ªæ•°æ®åŒ…çš„å±‚é¢è¿›è¡Œåˆ’åˆ†ã€‚å¯¹æ¯ä¸ªæ•°æ®åŒ…æ¥è¯´é€‰æ‹©å½“å‰æƒé‡æœ€å¤§çš„ RS è¿›è¡Œè½¬å‘å¹¶æ›´æ–°å…¶å½“å‰æƒé‡ 

* IWRR (Interleaved WRRï¼Œäº¤é”™çš„åŠ æƒè½®è¯¢)

IWRR å°½é‡å¼ºè°ƒäº†è½®è¯¢çš„å¤„ç†ï¼Œä¿è¯è°ƒåº¦åˆæœŸæ˜¯ä»¥è½®è¯¢çš„æ–¹å¼é€‰æ‹©ï¼Œç›´åˆ°å…¶å½“å‰æƒé‡åˆ° 0 å°±ç›´æ¥è·³è¿‡

**é—®é¢˜ï¼š**æƒé‡å·®

1. WRR çš„æƒé‡é…ç½®ä¸­å¦‚æœå‡ºç°ç›¸å·®è¾ƒå¤šçš„æƒé‡å·®ï¼Œå°±ä¼šå¯¼è‡´æŸä¸€æ®µæ—¶é—´é‡Œåšå‡º**è¿ç»­ç›¸åŒ**çš„è°ƒåº¦é€‰æ‹©ã€‚è¿™å¯¹ LB æ¥è¯´æ˜¯æ¯”è¾ƒè‡´å‘½çš„ï¼Œä» RS çš„è§’åº¦è€ƒè™‘ï¼Œè¿™ä¸€å°è¾ƒé«˜ä¼šåœ¨çŸ­æ—¶é—´å†…æ‰“å…¥å¤§é‡çš„æ–°è¿æ¥ -> **å¹³æ»‘**å¤„ç†ï¼Œæ‰“æ•£é«˜æƒé‡çš„è¿ç»­è°ƒåº¦
2. ä¸€æ•´è½®**è°ƒåº¦ä¸­é—´çš„æƒé‡æ›´æ–°**ä¼šå¯¼è‡´é‡æ–°å¼€å§‹çš„è°ƒåº¦ï¼Œä»æ›´é•¿çš„æ—¶é—´çº¿ä¸Šçœ‹ä¼šåŠ å‰§è¿ç»­è°ƒåº¦çš„é—®é¢˜ -> **æƒé‡å»¶è¿Ÿæ›´æ–°**ï¼Œåªæ›´æ–° RS æƒé‡ä½†ä¸ä¿®æ”¹å½“å‰æƒé‡å€¼ï¼Œä¼šä½¿å¾—æ–°æƒé‡åœ¨ä¸‹ä¸€è½®æ‰ä¼šè¢«æ„ŸçŸ¥åˆ°

### SWRR

* SWRR (Smooth Weighted Round Robinï¼Œå¹³æ»‘åŠ æƒè½®è¯¢)

ä¸ºäº†èƒ½æ‰“æ•£é«˜æƒé‡çš„è¿ç»­è°ƒåº¦ï¼Œå¸Œæœ›èƒ½æœ‰ä¸€ç§æ–¹æ³•æŠŠè¿ç»­è°ƒåº¦å°½å¯èƒ½å¹³æ»‘çš„æ’å…¥åˆ°åˆ«çš„ä½ç½®é‡Œ

é¢„å…ˆè®¡ç®—æ€»æƒé‡

å¯¹äºæ¯ä¸€æ¬¡é€‰æ‹©ï¼š

1. é€‰æ‹©å½“å‰æƒé‡æœ€é«˜çš„ RS è°ƒåº¦
2. é€‰æ‹©çš„ RS å½“å‰æƒé‡å‡å»æ€»æƒé‡ï¼ŒåŠ é€ŸæŠ¹å¹³æƒé‡é—´çš„å·®å€¼
3. ä¸ºäº†ä¿è¯å½“æƒæƒé‡ä¹‹å’Œä»ç„¶ç­‰äºæ€»æƒé‡ï¼Œä¸ºæ¯ä¸ª RS çš„å½“å‰æƒé‡å¢åŠ å…¶å®šä¹‰çš„æƒé‡

**é—®é¢˜ï¼š**è°ƒåº¦æ—¶é—´å¼€é”€å’Œç›¸åŒè°ƒåº¦é€‰æ‹©

1. æ¯æ¬¡è°ƒåº¦éœ€è¦éå†æ‰€æœ‰çš„ RS æ‰¾åˆ°å½“å‰æƒé‡æœ€å¤§çš„ä¸€ä¸ªï¼ŒæŸ¥æ‰¾è°ƒåº¦**æ—¶é—´å¼€é”€**ä¸º O(N) æˆ– O(logN)ï¼ˆå¦‚æœé€‰æ‹©ç”¨ä¾‹å¦‚æœ€å°å †ç»´æŠ¤ï¼Œå°±éœ€è¦é¢å¤–èŠ±æ—¶é—´ç»´æŠ¤å †ï¼‰ï¼Œæ›´æ–°å½“å‰æƒé‡ O(N) -> **é¢„å…ˆè®¡ç®—**è°ƒåº¦é¡ºåºï¼Œè°ƒåº¦æ—¶å¯ä»¥ç›´æ¥ O(1) é€‰æ‹©
2. **é›†ç¾¤**ä¸­æ¯ä¸€ä¸ªå•æœºå’Œå•æœºä¸­æ¯ä¸€ä¸ª WORKER éƒ½ä¼šåšå‡ºç›¸åŒçš„è°ƒåº¦é€‰æ‹©ï¼Œä½¿å¾—ä»æ•´ä½“ä¸Šæ¥çœ‹ï¼ˆæˆ–ä» RS çš„è§’åº¦çœ‹ï¼‰LB ä¼šåšå‡ºå¤šæ¬¡è¿ç»­é‡å¤çš„è°ƒåº¦ -> è°ƒåº¦é¡ºåº**éšæœº**åˆå§‹ä½ç½®
3. å…¶ä»–ä¼˜åŒ–æ–¹æ¡ˆå‚è§ Nginx ç« èŠ‚

### VNSWRR

* VNSWRR (Virtual Node Smooth Weighted Round Robinï¼Œè™šæ‹ŸèŠ‚ç‚¹å¹³æ»‘åŠ æƒè½®è¯¢)

å¯¹äº SWRRï¼Œé¢„å…ˆè®¡ç®—å¥½å®Œæ•´çš„è°ƒåº¦é¡ºåºè¡¨ï¼Œå¹¶åœ¨ä¸€å¼€å§‹é€‰æ‹©éšæœºçš„ idx å¼€å§‹è°ƒåº¦ï¼Œä»è€Œæ‰“æ•£åˆšå¯åŠ¨æ—¶é›†ç¾¤æ•´ä½“çš„è¿ç»­ç›¸åŒè°ƒåº¦

**Step + Unordered List ä¼˜åŒ–**

é¢„å…ˆè®¡ç®—å®Œæ•´çš„è°ƒåº¦é¡ºåºè¡¨åœ¨ RS æ•°é‡è¾ƒå¤šçš„æ—¶å€™ä¼šæ¶ˆè€—è¾ƒé•¿çš„æ—¶é—´ï¼Œè€Œè¿™æ®µæ—¶é—´è¢«è®¤ä¸ºæ˜¯æ— æ³•å¼€å§‹è°ƒåº¦çš„

é€šè¿‡åˆ† Step è®¡ç®—æ¥å‹ç¼©ä¸€å¼€å§‹è®¡ç®—è°ƒåº¦é¡ºåºè¡¨çš„æ—¶é—´ï¼Œç›´åˆ°åç»­è°ƒåº¦éœ€è¦æ—¶å†è®¡ç®—ä¸‹ä¸€ä¸ª Step çš„è°ƒåº¦é¡ºåºï¼Œç›´åˆ°è®¡ç®—å®Œå®Œæ•´çš„è°ƒåº¦é¡ºåºè¡¨ã€‚ä½†æ˜¯è¿™å°±å¯¼è‡´éšæœº idx åªèƒ½åœ¨ä¸€ä¸ª Step çš„èŒƒå›´å†…é€‰æ‹©

æ‰“ä¹± RS åˆ—è¡¨é¡ºåºï¼Œä½¿ç›¸åŒæƒé‡çš„ RS åœ¨è®¡ç®—è°ƒåº¦é¡ºåºæ—¶ä¼šæœ‰æ›´ä¸ºéšæœºçš„é€‰æ‹©ï¼Œä»è€Œä½¿å¾—åœ¨ Step å†…çš„ idx éšæœºæ‰©å¤§åˆ° Step ç»“å°¾çš„ç›¸åŒæƒé‡éƒ¨åˆ†ï¼ˆç”±äº RS æƒé‡é…ç½®ä¸­åŠ VNSWRR è°ƒåº¦é¡ºåºè®¡ç®—çš„è¿‡ç¨‹ä¸­ç›¸åŒæƒé‡çš„å‡ºç°å¾ˆæ­£å¸¸ï¼ŒéšæœºèŒƒå›´æ‰©å¤§ï¼‰

**Step æ­¥é•¿å¤§å°é€‰æ‹©**

å®éªŒç»Ÿè®¡ç»“æœç¡®å®š

![å›¾ç‰‡](./media/image1.png)

æ¯ä¸€è½®è°ƒåº¦è®¡ç®—æ§åˆ¶åœ¨ 100k çº³ç§’ä»¥å†…

| **rs num** | **step** |
| ---------- | -------- |
| <= 200     | 128      |
| <= 300     | 64       |
| <= 400     | 32       |
| more       | 16       |

**GCD ä¼˜åŒ–**

è°ƒåº¦é¡ºåºè¡¨çš„é•¿åº¦å–å†³äºæ€»æƒé‡ï¼Œä½†å®é™…ä¸Šä¼šä»¥æ‰€æœ‰ RS æƒé‡çš„æœ€å°å…¬å€æ•°ä¸ºä¸€è½®ï¼ˆå®é™…ä¸Šæƒé‡æœ¬æ¥å°±å¯ä»¥é™¤æœ€å¤§å…¬çº¦æ•°è¿›è¡Œçº¦åˆ†ï¼Œç­‰æ•ˆæƒé‡ï¼‰ï¼Œæ‰€ä»¥åªéœ€è¦å­˜æ”¾ GCD åçš„æ€»æƒé‡é•¿åº¦

**é—®é¢˜ï¼š**åˆ†æ­¥è®¡ç®—ã€æƒé‡æ›´æ–°å’Œä¹±åºç®—æ³•

1. ç°åœ¨çš„åˆ†å¸ƒè®¡ç®—ä¼šåœ¨**å‰å‡ æ¬¡è°ƒåº¦æ—¶è®¡ç®—**ä¸‹ä¸€ä¸ª Step çš„è°ƒåº¦é¡ºåºè¡¨ -> æ”¹ä¸º next_idx å¿«åˆ° next_init_idx æ—¶å†è®¡ç®—ä¸‹ä¸€ä¸ª Stepï¼Œ**æ‰“æ•£è°ƒåº¦é¡ºåºçš„è®¡ç®—**
2. æ¯æ¬¡æœ‰ RS çš„**æƒé‡æ›´æ–°**éƒ½ä¼šå¯¼è‡´è°ƒåº¦é¡ºåºè¡¨éœ€è¦é‡æ–°è®¡ç®—ã€‚å¦‚æœæœ‰é¢‘ç¹çš„æƒé‡æ›´æ–°ï¼Œä¼šä½¿å¾—è°ƒåº¦é¡ºåºè¡¨çš„è®¡ç®—å¼€é”€è¢«æ”¾å¤§ -> é—®é¢˜1çš„è§£å†³æ–¹æ¡ˆèƒ½éƒ¨åˆ†ä¿è¯**ä¸ä¼šè¿ç»­çš„è®¡ç®—** Step å†…è°ƒåº¦é¡ºåº + è°ƒåº¦é¡ºåºçš„è®¡ç®—ç°åœ¨æ”¾åœ¨ CTRL çº¿ç¨‹ï¼Œå› è¯»å†™é”ä¸ WORKER çš„è°ƒåº¦äº’æ–¥ï¼Œæ”¹ä¸º **RCU** æœºåˆ¶ä½¿è®¡ç®—æ—¶çš„è°ƒåº¦å¯ä»¥ç»§ç»­ç”¨æ—§çš„è°ƒåº¦é¡ºåºè¡¨æ¥åšè°ƒåº¦é€‰æ‹©ï¼Ÿ + **å…¨å±€å®Œæ•´**çš„è°ƒåº¦é¡ºåºè¡¨è®¡ç®—ï¼ˆé˜»å¡ CTRL çº¿ç¨‹ï¼‰ï¼ŒWORKER æœ¬åœ°åªéšæœº next_idxï¼Ÿ
3. å½“å‰çš„**ä¹±åºç®—æ³•**æ˜¯å°†æ‰€æœ‰ RS ä»¥éšæœºé¡ºåºæŒ¨ä¸ªæ·»åŠ åˆ°æ–°çš„ä¸´æ—¶é“¾è¡¨é‡Œï¼ŒO(N^2) -> å‚è€ƒ**æ´—ç‰Œç®—æ³•**ï¼ŒBV1tNKfz1Eqc
   1. æ¯å¼ ç‰Œç»™éšæœºå€¼ï¼ŒæŒ‰ç…§éšæœºå€¼æ’åºï¼Œæ—¶é—´ O(NlogN)ï¼Œç©ºé—´ O(N) ä½†å¯ä»¥å’Œ Maglev ä¸€è‡´æ€§å“ˆå¸Œå…±ç”¨åå¥½æ•°ç»„
   2. æ–°ç‰ˆ Fisher-Yates ç®—æ³•ï¼šä¾èµ–æ•°ç»„ O(1) å–å€¼ã€‚ç»´æŠ¤ç‰Œå †æ•°ç»„çš„æ´—å¥½å’Œæœªæ´—ä¸¤éƒ¨åˆ†ï¼Œæ¯æ¬¡å°†æœªæ´—çš„æœ€åä¸€å¼ ç‰Œ last_idx ä¸éšæœºæœªæ´—ä½ç½® random_idx (0 ~ last_idx) çš„ç‰Œ O(1) äº¤æ¢ï¼Œå¹¶å°†æœ€åä¸€å¼  last_idx å½“ä½œæ´—å¥½çš„éƒ¨åˆ†ã€‚æœ€ç»ˆå¯ä»¥ O(N) æ—¶é—´éšæœºæ´—ç‰Œ -> éœ€è¦é¢å¤–å­˜å‚¨ä¸€ä¸ª RS æ•°ç»„ç”¨æ¥å– random_idx

## ä»æ•°æ®åŒ…é—´å­˜åœ¨é•¿çŸ­å·®å¼‚çš„è§’åº¦

æ•°æ®åŒ…ä¹‹é—´ä¼šæœ‰é•¿çŸ­ï¼ˆå°½ç®¡è¿™åœ¨ LB è®¤ä¸ºæ˜¯ä¸€è‡´çš„ï¼‰ï¼Œå®ƒå¯èƒ½å½±å“çš„æ›´å¤šæ˜¯æ”¶å‘åŒ…çš„æ—¶é—´å¼€é”€ï¼ˆå‡è®¾ RS æ­£åœ¨å¤§é‡æ”¶åŒ…ç”šè‡³æ¥è¿‘è¶…è¿‡å¤„ç†èƒ½åŠ›èŒƒå›´ï¼ŒRS çš„æ”¶åŒ…æˆä¸ºç“¶é¢ˆã€‚å› ä¸º LB ä¸éœ€è¦è€ƒè™‘è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥åªåšç®€å•ä»‹ç»ï¼‰

å‚è€ƒä¸Šä¸€ç« çš„æƒé‡åˆ†é…ï¼Œè¿™é‡Œå°†æ•°æ®åŒ…çš„å¤§å°ä½œä¸ºæƒé‡çš„å½±å“å› ç´ ã€‚åˆšå‘é€äº†é•¿æ•°æ®åŒ…çš„ RS ä¸åº”æˆä¸ºä¸‹ä¸€æ¬¡çš„é€‰æ‹©

### DWRR

* DWRR (Deflicit Weighted Round Robinï¼Œèµ¤å­—è½®è¯¢)

èµ¤å­—è®¡æ•°å™¨è¡¨ç¤ºæ­¤è½®å¯ä»¥å‘é€çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œå¦‚æœå…¶å¤§äºç­‰äºæ•°æ®åŒ…å¤§å°åˆ™æ­¤è½®å¯ä»¥å‘é€ï¼ˆå¹¶å°†è®¡æ•°å™¨å‡æ‰æ•°æ®åŒ…å¤§å°ï¼‰ï¼Œå¦åˆ™æ”¾åˆ°ä¸‹ä¸€è½®è€ƒè™‘ã€‚èµ¤å­—è®¡æ•°å™¨æ¯è½®å‡ç­‰å¢åŠ æˆ–æŒ‰ç…§æƒé‡é…ç½®å¢åŠ ã€‚å¯¹åº”åˆ° LB æ˜¯ä¸ºæ‰€æœ‰ RS ç»´æŠ¤èµ¤å­—è®¡æ•°å™¨ï¼Œæ¯è½®å¢åŠ æƒé‡å€¼ï¼Œå¹¶é€‰æ‹©ä¸‹ä¸€ä¸ªè®¡æ•°å™¨å€¼å¤§äºæ•°æ®åŒ…å¤§å°çš„ RS è°ƒåº¦

**ä¸åŒçš„ WRR ç®—æ³•å¯¹æ¯”**

| **Algorithm Compare**        |                                                              |                                                              |
| ---------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| (I)WRR (Packet number level) | å¾ªç¯è°ƒåº¦çš„**å‘¨æœŸçŸ­** (RR IWRR)<br />å®ç°ç®€å•ï¼Œä¸éœ€è¦ç»´æŠ¤å¤ªå¤šä¿¡æ¯<br />å¯ä»¥è®©**æƒé‡å»¶è¿Ÿæ›´æ–°**ï¼Œä¸éœ€è¦ç«‹åˆ»å“åº”æƒé‡å˜åŒ– | å¤§æŠ¥æ–‡è·å¾—çš„å®é™…**å¸¦å®½**è¦å¤§äºå°æŠ¥æ–‡<br />**æƒé‡å·®å€¼**è¾ƒå¤§ä¼šå¯¼è‡´æœ€åå¤§é‡æ–°è¿æ¥è¿ç»­æ‰“åˆ°åŒä¸€ä¸ª RS |
| DWRR (Bandwidth level)       | è€ƒè™‘**æŠ¥æ–‡é•¿åº¦**å¸¦æ¥çš„å¸¦å®½åˆ†é…é—®é¢˜                           | LB ä¸éœ€è¦è€ƒè™‘æŠ¥æ–‡é•¿åº¦å’Œå¸¦å®½åˆ†é…                             |
| SWRR (Packet level)          | **å¹³æ»‘**è§£å†³è¿ç»­æ‰“åˆ°åŒä¸€ä¸ª RS çš„é—®é¢˜                         | æ¯æ¬¡è°ƒåº¦éƒ½éœ€è¦æŸ¥æ‰¾å¹¶ç»´æŠ¤ï¼Œ**O(N)**<br />åˆå§‹æ—¶ä»¥åŠåŠ¨æ€è°ƒæ•´æƒé‡æ—¶ï¼Œæ‰€æœ‰ WORKER **ç›¸åŒåºåˆ—**è°ƒåº¦å‹åŠ›åŒä¸€ä¸ª RS |
| VNSWRR (RS level)            | é¢„å…ˆè®¡ç®—è°ƒåº¦é¡ºåºï¼Œ**O(1)** è°ƒåº¦<br />**æ‰“æ•£**åˆå§‹æ—¶å’Œè°ƒæ•´æƒé‡æ—¶åˆ° RS çš„æµé‡<br />**åˆ†æ­¥ step** æ›´æ–°å‡ç¼“è°ƒåº¦è®¡ç®—å¼€é”€ | WORKER ä¹‹é—´**ä¸å…±äº«**ï¼Œæ¯ä¸ªå•ç‹¬è®¡ç®—ä¸€éè°ƒåº¦é¡ºåºè¡¨<br />next_idx **éšæœºèŒƒå›´**ä¸æ˜¯å®Œæ•´çš„è°ƒåº¦é¡ºåºè¡¨é•¿åº¦ |

## ä»æœåŠ¡å™¨è¿æ¥çŠ¶æ€çš„è§’åº¦

ç›¸æ¯”äºé¢„å®šä¹‰çš„æƒé‡ä¿¡æ¯ï¼Œç»Ÿè®¡å½“å‰çš„è¿æ¥çŠ¶æ€å¯ä»¥æ›´çµæ´»çš„å¤„ç† RS çš„è°ƒåº¦é€‰æ‹©é—®é¢˜

å› ä¸º LB ä»¥é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼Œæœ¬èº«ä» RS ä¸Šæ”¶é›†ä¼šæ›´èƒ½è¡¨ç¤ºå…¶çœŸå®çš„å·²æœ‰çš„è¿æ¥çŠ¶æ€ï¼Œä½†æ˜¯éœ€è¦æ”¹é€  RS ä»¥ä¾‹å¦‚ Sidecar æ¨¡å¼é¢å¤–çš„æ”¶é›†ä¿¡æ¯ä¸”å¯¹ RS é€ æˆäº†é¢å¤–çš„å¼€é”€ã€‚å¯¹ LB æ›´ä¼˜çš„æ–¹å¼æ˜¯åœ¨è‡ªå·±é›†ç¾¤å†…è¿›è¡Œå…¨å±€çš„ç»Ÿè®¡

### minConn

* minConn (æœ€å°è¿æ¥æ•°)

ç»´æŠ¤å¯¹æ‰€æœ‰ RS çš„è¿æ¥æ•°ç»Ÿè®¡ï¼ˆå€Ÿä¼šè¯åŒæ­¥æ¥æ”¶é›†å…¶ä»– LB æœºå™¨ä¸Šçš„è¿æ¥æ•°ä¿¡æ¯ï¼‰ï¼Œæ¯æ¬¡é€‰æ‹©å½“å‰è¿æ¥æ•°æœ€å°‘çš„ RS è°ƒåº¦ã€‚é€šè¿‡ç»´æŠ¤è¿æ¥æ•°æœ€å°å †çš„æ–¹å¼ O(1) çš„é€‰æ‹©è°ƒåº¦å¹¶ O(logN) çš„ç»´æŠ¤ã€‚ä½†æ˜¯ç”±äº WORKER ä¹‹é—´ä¸å…±äº«ï¼Œéœ€è¦é¢å¤–çš„å®šæ—¶ä»»åŠ¡æ¥æ”¶é›†æ‰€æœ‰ WORKER çš„è¿æ¥æ•°ä¿¡æ¯æ›´æ–°åˆ°æ¯ä¸€ä¸ª WORKER æœ¬åœ°ï¼Œä¸”é¢å¯¹å¤§é‡çš„è¿æ¥æ•°æ›´æ–°ï¼Œç›´æ¥é‡å»ºå †ï¼›ç”±äºé›†ç¾¤å†…ä¸å…±äº«ï¼Œéœ€è¦ä¾é ä¼šè¯åŒæ­¥çš„æ–¹å¼æ¥è·å–å…¶ä»–æœºå™¨çš„è¿æ¥æ•°ç»Ÿè®¡

**é—®é¢˜ï¼š**WORKER é—´ä¸å…±äº«ã€é›†ç¾¤å†…ä¸å…±äº«ï¼ˆé•¿çŸ­è¿æ¥ï¼‰å’Œæƒé‡é…ç½®

æ—¢ç„¶åº”è¯¥é€‰æ‹©å…¨å±€ï¼ˆæˆ–è€…è¯´ä» RS è§’åº¦ï¼‰çš„æœ€å°è¿æ¥ï¼Œåœ¨è¿½æ±‚æ•ˆç‡è€Œ**ä¸å…±äº«**çš„ LB å°±éœ€è¦å…¶ä»–çš„æ–¹å¼æ¥å…±äº«è¿æ¥æ•°ä¿¡æ¯ã€‚

1. å®šæ—¶ä»»åŠ¡æ”¶é›†**æ‰€æœ‰ WORKER** è¿æ¥æ•°ä¿¡æ¯å’Œé‡å»ºæœ€å°å †
2. **é›†ç¾¤å†…**ä¼šè¯åŒæ­¥åªæ”¶é›†é•¿è¿æ¥ï¼Œé¢å¯¹å¤§é‡æŒç»­å»ºç«‹çš„æ–°**çŸ­è¿æ¥**æ²¡æœ‰åŠæ³•å»ºç«‹å…¨å±€è§†é‡
3. minConn è°ƒåº¦æ—¶ä¸ä¼šè€ƒè™‘ RS çš„**æƒé‡åˆ†é…**ï¼Œå»ºç«‹è¿æ¥æ—¶åªä¼šå°†æœ¬ WORKER è¿æ¥æ•° + worker_cnt -> å»ºç«‹è¿æ¥æ—¶è¿æ¥æ•° + worker_cnt * weightï¼Œç»Ÿè®¡æ—¶ä¹Ÿç›´æ¥è®¡ç®— conn_cnt * weight æ¥å»ºå †ï¼ˆæ³¨æ„è¿™é‡Œ"æƒé‡"è¶Šä½ï¼Œ"æƒé‡"è¶Šé«˜ :) æˆ–è€…æ”¹ä¸ºé™¤æƒé‡åå‘ä¸Šå–æ•´

## ä»å®Œå…¨éšæœºçš„è§’åº¦

é€šè¿‡å“ˆå¸Œçš„æ–¹å¼å¯ä»¥ä¿è¯ç›¸åŒçš„æ˜æ–‡å€¼æ¯æ¬¡éƒ½ä¼šå“ˆå¸Œä¸ºç›¸åŒçš„å¯†æ–‡ï¼ˆå¹‚ç­‰æ€§ï¼‰ï¼Œå¯ä»¥é¢å¤–çš„ä¿è¯ä¾‹å¦‚ç›¸åŒçš„ QUIC CID è½¬å‘åˆ°ç›¸åŒçš„ RS è¿›è¡Œå¤„ç†ï¼Œæˆ–æ˜¯æ–­å¼€çš„è¿æ¥ä¾é ç›¸åŒçš„äº”å…ƒç»„æ‰“å›ä¸ä¸Šä¸€æ¬¡è¿æ¥ç›¸åŒçš„ RS

**å…¬å¹³æ€§**ä¾é å“ˆå¸Œç®—æ³•çš„**æ•£åˆ—ç¨‹åº¦**

### å“ˆå¸Œå–æ¨¡

* hash

æ ¹æ®æŸä¸€ä¸ªç‰¹å®šçš„å€¼è¿›è¡Œå“ˆå¸Œï¼ˆéšæœºæ‰“æ•£ï¼‰ï¼Œå†å¯¹ RS æ•°é‡å–æ¨¡

LB æœ¬èº«å­˜å‚¨ RS æ˜¯ä»¥é“¾è¡¨å’Œå“ˆå¸Œæ¡¶çš„æ–¹å¼ï¼Œéœ€è¦å†é¢å¤–ä»¥æ•°ç»„å½¢å¼å­˜å‚¨è°ƒåº¦é¡ºåºè¡¨ä»¥ä¿è¯ O(1) çš„è°ƒåº¦é€‰æ‹©

**é—®é¢˜ï¼š**å¯ä»¥çœ‹åˆ°å…¶è°ƒåº¦å…¬å¹³çš„å½±å“å› ç´ ä¸ºå“ˆå¸Œç®—æ³•å’Œ RS æ•°é‡

1. é¦–å…ˆéœ€è¦ä¿è¯å“ˆå¸Œæ˜æ–‡çš„å”¯ä¸€å’Œå“ˆå¸Œç»“æœå°½é‡åˆ†æ•£ï¼Œå°¤å…¶å½“ **RS æ•°é‡è¾ƒå°‘**çš„æ—¶å€™ï¼Œè‹¥å†é‡åˆ°å“ˆå¸Œç¢°æ’å°±ä¼šå¯¼è‡´å¾ˆæ˜æ˜¾çš„è°ƒåº¦ä¸å‡ -> **å¡«å……è™šæ‹ŸèŠ‚ç‚¹**
2. **RS æ•°é‡å˜åŒ–**ä¼šå¯¼è‡´ä¹‹å‰å“ˆå¸Œçš„ç»“æœéƒ½å‘ç”Ÿæ”¹å˜ -> **ä¸€è‡´æ€§å“ˆå¸Œ**é™ä½å½±å“

![å›¾ç‰‡](./media/image2.png){width="5.5in"
height="1.4780511811023622in"}

### ä¸€è‡´æ€§å“ˆå¸Œ

è€ƒè™‘åˆ°æ‰©ç¼©å®¹æ˜¯å¾ˆå¸¸è§çš„äº‹æƒ…ï¼Œä¸€è‡´æ€§å“ˆå¸Œå¸Œæœ›èƒ½å‡å°æ‰©ç¼©å®¹å¸¦æ¥çš„å½±å“

ä½†æ˜¯å¯¹ LB æ¥è¯´ï¼Œå¤§å¤šæ•°åªéœ€è¦é€‰æ‹©å‡ºè°ƒåº¦çš„ç»“æœï¼Œå¹¶ä¸éœ€è¦å¯¹ä¹‹å‰çš„è°ƒåº¦ç»“æœè´Ÿè´£ï¼ˆå·²ç”± CT è®°å½•ï¼‰ã€‚ä½†æ˜¯åœ¨ QUIC CID Hash åœºæ™¯ä¸‹ï¼Œå“ˆå¸Œå¸¦æ¥çš„å½±å“å°±æ›´æœ‰å¿…è¦è€ƒè™‘äº†

#### å“ˆå¸Œç¯ï¼ˆå‰²ç¯æ³•ï¼‰

> 1997

* å“ˆå¸Œç¯ï¼ˆå‰²ç¯æ³•ï¼‰

å“ˆå¸Œå€¼æ˜ å°„åˆ°ä¸€ä¸ªå¤§åœ†ç¯ (2^32) ç©ºé—´å†…çš„æ§½ä½ï¼ŒæŸ¥æ‰¾æ—¶åœ¨åœ†ç¯ä¸­é¡ºæ—¶é’ˆæŸ¥æ‰¾æ˜ å°„è¿‡çš„æ§½ä½

å½“å¾€ä¸€ä¸ªå“ˆå¸Œç¯ä¸­æ–°å¢ä¸€ä¸ªæ§½ä½æ—¶ï¼Œåªæœ‰è¢«æ–°å¢æ§½ä½æ‹¦ä¸‹æ¥çš„å“ˆå¸Œç»“æœçš„æ˜ å°„ç»“æœæ˜¯å˜åŒ–çš„

![å›¾ç‰‡](./media/image3.jpeg)

å½“ä»ä¸€ä¸ªå“ˆå¸Œç¯ä¸­ç§»é™¤ä¸€ä¸ªæ§½ä½æ—¶ï¼Œè¢«åˆ é™¤æ§½ä½çš„æ˜ å°„ä¼šè½¬äº¤ç»™ä¸‹ä¸€æ§½ä½ï¼Œå…¶ä»–æ§½ä½ä¸å—å½±å“

![å›¾ç‰‡](./media/image4.jpeg)

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿˜å¯ä»¥å¯¹æ§½ä½ï¼ˆèŠ‚ç‚¹ï¼‰æ·»åŠ **æƒé‡**ï¼Œé€šè¿‡æ„å»ºå¾ˆå¤šæŒ‡å‘çœŸå®èŠ‚ç‚¹çš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œä¹Ÿå«å½±å­èŠ‚ç‚¹ã€‚é€šå¸¸é‡‡ç”¨ä¸€ä¸ªèŠ‚ç‚¹åˆ›å»º 40 ä¸ªå½±å­èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹è¶Šå¤šæ˜ å°„åˆ†å¸ƒè¶Šå‡åŒ€ã€‚å½±å­èŠ‚ç‚¹ä¹‹é—´æ˜¯å¹³æƒçš„ï¼Œé€‰ä¸­å½±å­èŠ‚ç‚¹ï¼Œå°±ä»£è¡¨é€‰ä¸­äº†èƒŒåçš„çœŸå®èŠ‚ç‚¹ã€‚æƒé‡è¶Šå¤§çš„èŠ‚ç‚¹ï¼Œå½±å­èŠ‚ç‚¹è¶Šå¤šï¼Œè¢«é€‰ä¸­çš„æ¦‚ç‡å°±è¶Šå¤§ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½±å­èŠ‚ç‚¹å¢åŠ äº†å†…å­˜æ¶ˆè€—å’ŒæŸ¥è¯¢å¼€é”€ï¼Œæƒé‡çš„è°ƒæ•´ä¹Ÿä¼šå¸¦æ¥æ•°æ®è¿ç§»çš„å·¥ä½œ

![å›¾ç‰‡](./media/image5.jpeg)

**ä¼˜åŠ¿ï¼š**ä¸€è‡´æ€§å“ˆå¸Œå’Œæƒé‡åˆ†é…

**é—®é¢˜ï¼š**è°ƒåº¦æŸ¥æ‰¾å¼€é”€å’Œé¢å¤–ç©ºé—´å¼€é”€

1. è°ƒåº¦æ—¶éœ€è¦åœ¨å“ˆå¸Œç¯ä¸­é¡ºåºçš„æŸ¥æ‰¾åˆ°æ§½ä½ï¼ˆæˆ–è™šæ‹ŸèŠ‚ç‚¹ï¼‰ï¼Œé€ æˆé¢å¤–çš„**æŸ¥æ‰¾å¼€é”€** -> é¢„å…ˆå¡«å……æ•´ä¸ªå“ˆå¸Œç¯ï¼Œåº”è¯¥å¯ä»¥çœ‹ä½œ O(1) è°ƒåº¦æŸ¥æ‰¾
2. éœ€è¦å¼€è¾Ÿå¤§é‡**ç©ºé—´**ç”¨æ¥åšå“ˆå¸Œç¯å’Œå½±å­èŠ‚ç‚¹
3. å“ˆå¸Œç¯ç®—æ³•çš„æ˜ å°„ç»“æœä¸æ˜¯å¾ˆå‡åŒ€ï¼Œå½“æœ‰ 100 ä¸ªå½±å­èŠ‚ç‚¹æ—¶ï¼Œæ˜ å°„ç»“æœçš„åˆ†å¸ƒçš„æ ‡å‡†å·®çº¦ 10%ï¼›å½“æœ‰ 1000 ä¸ªå½±å­èŠ‚ç‚¹æ—¶ï¼Œé™ä½åˆ°çº¦ 3.2% 

> [ä¸€è‡´æ€§å“ˆå¸Œï¼šç®—æ³•å‡è¡¡ by Damian Gryski](https://dgryski.medium.com/consistent-hashing-algorithmic-tradeoffs-ef6b8e2fcae8#890d)

> å®é™…çš„å®ç°æ–¹å¼ï¼š
> 1. å»ºç«‹ä»¥å½±å­èŠ‚ç‚¹ hash å€¼æ’åºçš„è™šæ‹ŸèŠ‚ç‚¹é“¾è¡¨ï¼Œå¹¶åœ¨è¿™åŸºç¡€ä¸Šä»¥ç±»ä¼¼è·³è¡¨çš„å½¢å¼åŠ é€ŸæŸ¥è¯¢æ—¶ hash å®šä½å½±å­èŠ‚ç‚¹
> ```c
> hash_ring {
> len;  // shadow_node length = sum(node * weight * shadow_cnt)
> shadow_node list;
> }
> shadow_node {
> *rs;
> hash;
> *next_shadow_node;
> }
> jump_list[level][] = {};
> ```
> è·³è¡¨çš„å±‚æ•°å’Œåˆ é™¤ï¼Œé€»è¾‘å¤æ‚
>  
> 2. æ”¹ä¸ºç”¨æ•°ç»„å­˜å‚¨è™šæ‹ŸèŠ‚ç‚¹è¡¨ï¼ŒåŒæ ·ä»¥å½±å­èŠ‚ç‚¹çš„ hash å€¼æ’åºã€‚æŸ¥æ‰¾æ—¶å¯¹æŸ¥è¯¢çš„ key hash å€¼äºŒåˆ†æŸ¥æ‰¾ï¼Œç®€åŒ–é€»è¾‘ï¼ˆæ™®éé€‰æ‹©çš„åšæ³•ï¼‰
> æŸ¥è¯¢åŒæ ·æ˜¯ O(logN)
>  
> 3. å¹³é“ºé¢„å¡«å……ï¼Œå¯¹ hash å€¼èŒƒå›´è¿›è¡Œé™åˆ¶ï¼Œå°† RS æŒ‡é’ˆç›´æ¥å¡«å……åˆ° hash èŒƒå›´å¤§å°çš„æ•°ç»„é‡Œ O(1) æŸ¥æ‰¾
> å¦‚æœæ˜¯ 32bits çš„å“ˆå¸ŒèŒƒå›´ï¼Œå°±ä»£è¡¨éœ€è¦å¼€è¾Ÿ sizeof(ptr) * pow(2, 32) å¤§å°çš„æ•°ç»„ï¼Œ4 å­—èŠ‚æŒ‡é’ˆæ—¶æ€»å­˜å‚¨çº¦ä¸º 17GBã€‚ä½†å¦‚æœæ˜¯ 16bits (65536)ï¼Œå°±åªéœ€è¦ 256KB

#### Jump Hash è·³è·ƒä¸€è‡´æ€§å“ˆå¸Œ

* Jump Hash è·³è·ƒä¸€è‡´æ€§å“ˆå¸Œ

> A Fast, Minimal Memory, Consistent Hash Algorithm
> https://arxiv.org/abs/1406.2294
> 2014

```
int32_t JumpConsistentHash(uint64_t key, int32_t num_buckets) {
    int64_t b = -1, j = 0;
    while (j < num_buckets) {
        b = j;
        key = key * 2862933555777941757ULL + 1;
        j = (b + 1) * (double(1LL << 31) / double((key >> 33) + 1));
    }
    return b;
}
```

å½“æ§½ä½æ•°é‡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¯ä»¥ç›´æ¥è®¡ç®—æœ‰å¤šå°‘ä¸ªå“ˆå¸Œç»“æœéœ€è¦é‡æ–°æ˜ å°„ã€‚é€šè¿‡ä¼ªéšæœºæ•°æ¥å†³å®šä¸€ä¸ªå“ˆå¸Œç»“æœæ¯æ¬¡è¦ä¸è¦è·³åˆ°æ–°çš„æ§½ä½ä¸­å»ï¼Œæœ€ç»ˆåªéœ€è¦ä¿è¯æ–°çš„æ¡¶ä¸­æœ‰ key_cnt / slot_cnt ä¸ªä»å‰é¢æ§½ä½ç§»åŠ¨è¿‡æ¥çš„ key å³å¯ä¿è¯æœ€å°åŒ–é‡æ–°æ˜ å°„

ç”±äºæ˜¯é€šè¿‡ä¼ªéšæœºçš„æ–¹å¼ï¼Œå¹¶å°†å“ˆå¸Œ key ä½œä¸ºä¼ªéšæœºæ•°ç§å­ï¼Œå¯¹äºç»™å®šçš„å“ˆå¸Œæ§½ä½æ•°é‡ï¼Œkey çš„æ˜ å°„ç»“æœéƒ½æ˜¯å”¯ä¸€ç¡®å®šçš„

![å›¾ç‰‡](./media/image6.jpeg)

ã€Œä¼ªéšæœºå“ˆå¸Œä¼˜åŒ–ã€

åœ¨ä¸Šé¢çš„å®ç°é‡Œï¼Œéœ€è¦åˆ¤æ–­ N æ¬¡ä¼ªéšæœºå€¼æ¥ç¡®å®šæ˜¯å¦è¦è·³è·ƒåˆ°å½“å‰çš„æœ€å¤§æ¡¶ä¸Šï¼Œè®¡ç®—å“ˆå¸Œæ‰€éœ€è¦èŠ±è´¹çš„æ—¶é—´æ—¶é—´ O(N)ã€‚ä½†æ˜¯æ³¨æ„åˆ°å…ƒç´ åªæœ‰å¾ˆå°çš„æ¦‚ç‡ä¼šç§»åŠ¨ï¼Œå®ƒåªä¼šåœ¨æ¡¶å¢åŠ æ—¶ç§»åŠ¨ï¼Œä¸”æ¯æ¬¡ç§»åŠ¨éƒ½å¿…ç„¶ç§»åŠ¨åˆ°æœ€æ–°çš„æ¡¶é‡Œï¼Œå³å¦‚æœä¸€ä¸ªå…ƒç´ ç§»åŠ¨åˆ° b å·æ¡¶ï¼ˆä» 0 å¼€å§‹è®¡å·ï¼‰é‡Œï¼Œå¿…ç„¶æ˜¯å› ä¸ºæ¡¶å¢åŠ åˆ° b+1 ä¸ªå¯¼è‡´ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ±‚å‡ºä¸‹ä¸€æ¬¡ç§»åŠ¨çš„ç›®æ ‡ jï¼Œå³å¯è·³è¿‡ b+2 ... j æ¬¡ä¼ªéšæœºçš„æ­¥éª¤

ä¸‹ä¸€æ¬¡ç§»åŠ¨åˆ° j æ„å‘³ç€ b+2 ... j éƒ½ä¼ªéšæœºåˆ°äº†ä¸ç§»åŠ¨ã€‚å¦æˆ‘ä»¬çŸ¥é“å½“æ¡¶å¢åŠ åˆ° N ä¸ªæ—¶å…ƒç´ çš„ç§»åŠ¨æ¦‚ç‡ä¸º 1/Nï¼Œä¸ç§»åŠ¨çš„æ¦‚ç‡ä¸º (N-1)/Nã€‚æ‰€ä»¥å…ƒç´ ç§»åŠ¨åˆ° j çš„æ¦‚ç‡ Pj ä¸º
$$
Pj = (b+1)(b+2)(b+3)...(j-1) / (b+2)(b+3)(b+4)...j = (b + 1) / j\\
j = (b + 1) / Pj
$$
é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ”¹å˜æ€è·¯ï¼Œå°† Pj ä½œä¸ºä¼ªéšæœºçš„å€¼ rï¼Œå°±å¯ä»¥ç›´æ¥é€šè¿‡ä¼ªéšæœºå€¼æ¥è·å– j äº†
$$
j = floor((b + 1) / r)
$$
ä¼˜åŒ–å‰çš„ä»£ç ä¸º

```
int consistent_hash(int key, int num_buckets) {
    srand(key);
    int b = 0;
    for (int n = 2; n <= num_buckets; ++n) {
        if ((double)rand() / RAND_MAX < 1.0 / n)
            b = n - 1;
    }
    return b;
}
```

ä¼˜åŒ–åçš„ä»£ç ä¸º

```
int consistent_hash(int key, int num_buckets) {
    srand(key);
    int b = 1, j = 0;
    while (j < num_buckets) {
        b = j;
        r = (double)rand() / RAND_MAX;
        j = floor((b + 1) / r);
    }
    return b;
}
```

æœ€ç»ˆå°†è·³è·ƒä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„æ—¶é—´ä¼˜åŒ–åˆ° O(logN) 

**ä¼˜åŠ¿ï¼š**åœ¨æ‰§è¡Œé€Ÿåº¦ã€å†…å­˜æ¶ˆè€—ã€æ˜ å°„å‡åŒ€æ€§ä¸Šéƒ½æ¯”å“ˆå¸Œç¯ç®—æ³•æ›´å¥½ï¼Œæ—¶é—´å¯ä»¥ç”± O(N) ä¼˜åŒ–è‡³ O(logN)

**é—®é¢˜ï¼š**

1. æ— æ³•è‡ªå®šä¹‰æ§½ä½æ ‡å·ï¼Œå¿…é¡»ä» 0 å¼€å§‹ï¼Œæ„å‘³ç€éœ€è¦ rs_buf æ•°ç»„
2. åªèƒ½åœ¨**å°¾éƒ¨å¢åˆ **èŠ‚ç‚¹ï¼Œå¯¼è‡´åˆ é™¤ä¸­é—´èŠ‚ç‚¹ i éœ€è¦å…ˆæŠŠåé¢æ‰€æœ‰çš„ [i:] éƒ½åˆ æ‰ï¼Œå†æŠŠ [i+1:] çš„æ·»åŠ å›æ¥ -> LB ä¸éœ€è¦æŒä¹…åŒ–è¿æ¥ï¼ˆç»´æŠ¤å·²å»ºç«‹è¿‡çš„è¿æ¥ keyï¼‰ä¸éœ€è¦ç®¡

> å®é™…çš„å®ç°æ–¹å¼ï¼š
>
> 1. åœ¨è´Ÿè½½å‡è¡¡è°ƒåº¦çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœä¸€ä¸ªè¿æ¥å»ºç«‹åæ–­å¼€ï¼Œä¸‹ä¸€æ¬¡åˆæ¥å»ºç«‹è¿æ¥ï¼Œå°±è¦çœ‹æ˜¯å¦éœ€è¦é‡å›åˆ°ä¹‹å‰çš„è°ƒåº¦ï¼Œè¿™ä¹Ÿæ˜¯ä¸€è‡´æ€§å“ˆå¸Œæƒ³è¦æ§åˆ¶çš„é—®é¢˜ã€‚å¦‚æœä¸éœ€è¦å¯¹æŒä¹…åŒ–åš 100% ä¿è¯ï¼Œé‚£ä¹ˆè·³è·ƒä¸€è‡´æ€§å“ˆå¸Œå°±ä¸éœ€è¦ç»´æŠ¤ key çš„ç§»åŠ¨ï¼Œä»…ä»…éœ€è¦ä½¿ç”¨  `JumpConsistentHash` é€‰æ‹©å‡ºè°ƒåº¦çš„ RS å³å¯
>
>    RS_idx <- JumpConsistentHash <- key(srcIP or QUIC cid), RS_num

#### Multi-Probe ä¸€è‡´æ€§å“ˆå¸Œ (MPCH)

* Multi-Probe ä¸€è‡´æ€§å“ˆå¸Œ

> Multi-Probe Consistent Hashing
>
> https://arxiv.org/abs/1505.00062
>
> 2015

ç›®æ ‡ï¼šçµæ´»è°ƒèŠ‚èŠ‚ç‚¹å¤§å°å’Œé™ä½æ–¹å·®

åŸºæœ¬æ€æƒ³æ˜¯åœ¨å“ˆå¸Œç¯çš„åŸºç¡€ä¸ŠæŸ¥æ‰¾æ—¶å¯¹ key è¿›è¡Œ k æ¬¡å“ˆå¸Œï¼Œè¿”å›æ‰€æœ‰å“ˆå¸ŒæŸ¥è¯¢ä¸­è·ç¦»æœ€è¿‘çš„èŠ‚ç‚¹ã€‚k çš„å€¼ç”±æ‰€éœ€çš„æ–¹å·®å†³å®šã€‚å¯¹äºå³°å‡å€¼æ¯” 1.05ï¼ˆè´Ÿè½½æœ€é‡çš„èŠ‚ç‚¹æœ€å¤šæ¯”å¹³å‡å€¼é«˜ 5%ï¼‰ï¼Œk ä¸º 21ã€‚ä½œä¸ºå¯¹æ¯”ï¼Œå“ˆå¸Œç¯ç®—æ³•éœ€è¦ 700lnN ä¸ªå‰¯æœ¬ã€‚å¯¹äº 100 ä¸ªèŠ‚ç‚¹ï¼Œè¿™ç›¸å½“äºè¶…è¿‡ 1MB å†…å­˜

![å›¾ç‰‡](./media/image7.jpeg)

#### Maglev ä¸€è‡´æ€§å“ˆå¸Œ

* Maglev ä¸€è‡´æ€§å“ˆå¸Œ

> Maglev: A Fast and Reliable Software Network Load Balancer
>
> https://research.google/pubs/maglev-a-fast-and-reliable-software-network-load-balancer/
>
> 2016

å»ºç«‹ä¸€ä¸ªæ§½ä½æŸ¥æ‰¾è¡¨ï¼Œå¯¹è¾“å…¥ key å“ˆå¸Œå–ä½™å°±å¯ä»¥æ˜ å°„åˆ°ä¸€ä¸ªæ§½ä½ã€‚è®¡ç®—æŸ¥æ‰¾è¡¨éœ€è¦ä¸ºæ¯ä¸ªæ§½ä½ç”Ÿæˆä¸€ä¸ªåå¥½åºåˆ— Permutationï¼ŒæŒ‰ç…§åå¥½åºåˆ—ä¸­æ•°å­—çš„é¡ºåºï¼Œæ¯ä¸ªæ§½ä½è½®æµå¡«å……æŸ¥æ‰¾è¡¨ã€‚å¦‚æœå¡«å……çš„ç›®æ ‡ä½ç½®å·²è¢«å ç”¨ï¼Œåˆ™é¡ºå»¶è¯¥åºåˆ—çš„ä¸‹ä¸€ä¸ªç›®æ ‡ä½ç½®å¡«å……

![å›¾ç‰‡](./media/image8.jpeg)

ä¼ªä»£ç 

![å›¾ç‰‡](./media/image9.png)

ç”±äºå­˜å‚¨äº†åå¥½åºåˆ—è¡¨ï¼Œæ§½ä½çš„å˜åŠ¨å¯¹æŸ¥æ‰¾è¡¨çš„å½±å“å°±æ˜¯å¯æ§çš„äº†

![å›¾ç‰‡](./media/image10.jpeg)

ç”Ÿæˆåå¥½åºåˆ—çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œåªéœ€è¦ä¿è¯å…¶éšæœºå’Œå‡åŒ€ã€‚æŸ¥æ‰¾è¡¨çš„é•¿åº¦ M åº”æ˜¯ä¸€ä¸ªè´¨æ•°ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å“ˆå¸Œç¢°æ’å’Œèšé›†ï¼Œè®©åˆ†å¸ƒæ›´å‡åŒ€ã€‚æŸ¥æ‰¾è¡¨å»ºç«‹æ—¶é—´ O(MlogM)ï¼Œæœ€å O(M^2)

å¦‚æœæƒ³è¦å®ç°**å¸¦æƒé‡**çš„ Maglev å“ˆå¸Œï¼Œå¯ä»¥é€šè¿‡æ”¹å˜æ§½ä½é—´å¡«è¡¨çš„ç›¸å¯¹é¢‘ç‡æ¥å®ç°åŠ æƒ

> å…³äºæ—¶é—´å¤æ‚åº¦è®¡ç®—ï¼Œå¯ä»¥å‚è€ƒ [Maglev å“ˆå¸Œçš„å¤æ‚åº¦åˆ†æ](https://writings.sh/post/consistent-hashing-algorithms-part-4-maglev-consistent-hash#maglevå“ˆå¸Œçš„å¤æ‚åº¦åˆ†æ)

ã€Œéšæœºç”Ÿæˆåå¥½åºåˆ— permutationã€

Google æ–¹æ³•æ˜¯ï¼Œå–ä¸¤ä¸ªæ— å…³çš„å“ˆå¸Œå‡½æ•° h1 h2ï¼Œç»™æ§½ä½ b ç”Ÿæˆæ—¶ï¼Œå…ˆç”¨å“ˆå¸Œè®¡ç®— offset å’Œ skip
$$
offset = h1(b) \% M\\
skip = h2(b) \% (M-1) + 1
$$
ç„¶åå¯¹æ¯ä¸ª jï¼Œè®¡ç®—
$$
permutation[j] = (offset + j * skip) \% M
$$
è¿™é‡Œé€šè¿‡ç±»ä¼¼äºŒæ¬¡å“ˆå¸Œçš„æ–¹æ³•ï¼Œä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹æ— å…³çš„å“ˆå¸Œå‡½æ•°æ¥å‡å°‘æ˜ å°„ç»“æœçš„ç¢°æ’æ¬¡æ•°ï¼Œæé«˜éšæœºæ€§ã€‚ä½†æ˜¯è¿™è¦æ±‚ M å¿…é¡»æ˜¯è´¨æ•°ï¼Œæ‰èƒ½ä¿è¯ä¸ skip äº’è´¨ï¼Œæœ€ç»ˆéå†å®Œæ•´ä¸ª M

ã€Œæ§½ä½å¢åˆ åˆ†æã€

> Experiments in Google Paper Section 5.3

å®éªŒè®¾ç½®ï¼š1000 å°åç«¯æœåŠ¡å™¨ï¼Œå¯¹æ¯ä¸ª k-failure é‡æ–°ç”ŸæˆæŸ¥æ‰¾è¡¨å¹¶æ£€æŸ¥å…¥å£å˜åŒ–ï¼Œé‡å¤ 200 æ¬¡å–å¹³å‡å€¼

![å›¾ç‰‡](./media/image11.png)

æŒ‰ç…§å®éªŒç»“æœï¼ŒM = 65537ï¼Œk = 5 æ—¶ï¼Œåªæœ‰çº¦ 1180 ä¸ªå…¥å£ä¼šå˜åŒ– (çº¦ 1.8%)

> Google è®ºæ–‡ä¸­è¯´æ ¸å¿ƒå…³æ³¨çš„ä¸¤ä¸ªé—®é¢˜æ˜¯ï¼š
> 1. **load balancing**: each backend will receive an almost equal number of connections.
> 2. **minimal disruption**: when the set of backends changes, a connection will likely be sent to the same backend as it was before
> å…¶ä¸­ç¬¬ä¸€ä¸ªæ˜¯æœ€ä¸ºå…³é”®çš„ï¼ŒåŒæ—¶ Maglev æ¯ä¸ª VIP ç»‘å®šåˆ°åç«¯çš„å‡ ç™¾ä¸ªæœåŠ¡å™¨ï¼Œæ¯ä¸ªéƒ½éœ€è¦å¾ˆå¤§çš„ lookup tableã€‚å¹¶ä¸”ï¼Œå°½ç®¡æƒ³è¦æœ€å°åŒ–ä¸€è‡´æ€§å“ˆå¸Œåœ¨æ‰©ç¼©å®¹åœºæ™¯ä¸‹çš„å˜åŒ–ï¼Œä½†å› ä¸ºæœ‰ connections' affinity äº²å’Œæ€§ (conntrack) ï¼ˆä¸”è¿æ¥å¤ç”¨çš„ reset ä¹Ÿæ˜¯è¢«å…è®¸çš„ï¼‰ï¼Œå°‘é‡çš„æ§½ä½å¢åˆ å¹²æ‰°ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„


**ä¼˜åŠ¿ï¼š**O(1) çš„è°ƒåº¦æŸ¥æ‰¾ã€å‡åŒ€ä¸”ä¸€è‡´æ€§çš„å“ˆå¸Œæ˜ å°„å’Œå¯ä»¥å¢åŠ æƒé‡çš„å½±å“

**é—®é¢˜ï¼š**

1. éœ€è¦**é¢å¤–å­˜å‚¨**æ¯ä¸ªæ§½ä½çš„åå¥½åºåˆ—å’Œæ§½ä½æŸ¥æ‰¾è¡¨ (rs_buf)
2. è™½ç„¶é¿å…äº†å…¨å±€é‡æ–°æ˜ å°„ï¼Œä½†æ˜¯æ²¡æœ‰åšåˆ°æœ€å°åŒ–çš„é‡æ–°æ˜ å°„
3. Google çš„æµ‹è¯•é‡Œï¼Œ65537 å¤§å°çš„æŸ¥æ‰¾è¡¨ç”Ÿæˆæ—¶é—´ä¸º 1.8msï¼Œ655373 å¤§å°çš„æŸ¥æ‰¾è¡¨ç”Ÿæˆæ—¶é—´ä¸º 22.9ms

#### AnchorHash ä¸€è‡´æ€§å“ˆå¸Œ

> AnchorHash: A Scalable Consistent Hash
> https://arxiv.org/abs/1812.09674
> 2020

* AnchorHash ä¸€è‡´æ€§å“ˆå¸Œ

> æ± åŒ–+æ ‡è®°çš„æ€æƒ³ï¼Œé€šè¿‡å¤ç”¨æ¥å‡å°‘é‡æ˜ å°„

æƒ³è§£å†³æ§½ä½å¢åˆ æ—¶çš„é«˜è¿ç§»æˆæœ¬å’Œå¹³è¡¡æ€§ä¸‹é™é—®é¢˜

é¢„å…ˆå®šä¹‰å›ºå®šå¤§å° aï¼ˆé¢„æœŸå¯èƒ½è¾¾åˆ°çš„æœ€å¤§èŠ‚ç‚¹è§„æ¨¡ï¼‰çš„è™šæ‹ŸèŠ‚ç‚¹é›†åˆä¸ºé”šç‚¹é›†ï¼Œå·¥ä½œèŠ‚ç‚¹æ˜¯é”šç‚¹é›†çš„å­é›†

å½“å¯¹ key åˆ†é…æ—¶ï¼Œ

1. å…ˆç”¨ H1(key) æ˜ å°„åˆ°é”šç‚¹é›†çš„ä¸€ä¸ªæ¡¶ b
2. å¦‚æœæ¡¶ b æ˜¯å·¥ä½œèŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥åˆ†é…
3. å¦åˆ™å¯åŠ¨å›å¡«è¿‡ç¨‹
   1. ç”¨å¦ä¸€ä¸ªå“ˆå¸Œ H2(key) è®¡ç®—ä¸€ä¸ªèµ·å§‹ç‚¹
   2. åœ¨é”šç‚¹é›†æŒ‰é¡ºåºæŸ¥æ‰¾ä¸‹ä¸€ä¸ªæ˜¯å·¥ä½œèŠ‚ç‚¹çš„æ¡¶ b'

è®¾è®¡äº†ä¸€ä¸ª next æ•°ç»„ç”¨æ¥è¡¨ç¤ºå½“å‰æ¡¶ä¸å¯ç”¨æ—¶åº”è¯¥ä»å“ªæ‰¾ä¸‹ä¸€ä¸ªå€™é€‰æ¡¶ï¼Œåœ¨èŠ‚ç‚¹å¢åˆ æ—¶ç»´æŠ¤ next æŒ‡é’ˆ

![anchorHash removal](./media/anchorHash removal.png)

GetBucket æ—¶é—´ä¸º $1+ln(\dfrac{a}{w})$

![å›¾ç‰‡](./media/image12.jpeg)

M: Mapper from anchor A to rs S

R: Removed label

**ä¼˜åŠ¿ï¼š**

1. åˆ é™¤èŠ‚ç‚¹æ—¶ï¼Œåªå½±å“ç›´æ¥æ˜ å°„åˆ°è¯¥èŠ‚ç‚¹æ¡¶ä»¥åŠé€šè¿‡å›å¡«è·¯å¾„ä¾èµ–è¯¥æ¡¶çš„ key
2. å­˜å‚¨å›ºå®šå¤§å°çš„æ•°ç»„è®°å½•ï¼Œä¸éœ€è¦è™šæ‹ŸèŠ‚ç‚¹
3. æŸ¥æ‰¾é€šå¸¸åªéœ€è¦ä¸€æ¬¡åˆå§‹å“ˆå¸Œå’Œå¹³å‡ä¸åˆ°ä¸€æ¬¡å›å¡«è·³è½¬
4. ä¸ä¼šå› ä¸ºå…¶ä»–èŠ‚ç‚¹çš„å¢åˆ è€Œå½±å“å½“å‰èŠ‚ç‚¹çš„æ˜ å°„ key
5. è´Ÿè½½å¹³è¡¡æ€§é«˜è¾ƒå‡åŒ€ï¼Œé”®åˆ†é…åˆ°å·¥ä½œèŠ‚ç‚¹çš„æ–¹å·®è¾ƒä½

**é—®é¢˜ï¼š**

1. é¢å¤–çš„å†…å­˜å¼€é”€æ¥å­˜å‚¨ä¸‰ä¸ª O(a) æ•°ç»„ workers, removed, next
2. æ–°å¢èŠ‚ç‚¹åªæ¥æ”¶æ˜ å°„åˆ°å®ƒè‡ªèº«æ¡¶çš„æ–°é”®å’Œæœªæ¥å› å…¶ä»–èŠ‚ç‚¹ç¦»å¼€è€Œå›å¡«çš„é”®ï¼Œä¸ä¼šç«‹å³åˆ†æ‹…ç°æœ‰èŠ‚ç‚¹çš„è´Ÿè½½
3. éœ€è¦ç»´æŠ¤ next æŒ‡é’ˆçš„é€»è¾‘è¾ƒä¸ºå¤æ‚

#### DxHash ä¸€è‡´æ€§å“ˆå¸Œ

> DxHash: A Scalable Consistent Hashing Based on the Pseudo-Random Sequence
>
> arxiv.org/pdf/2107.07930
>
> 2021

* DxHash ä¸€è‡´æ€§å“ˆå¸Œ

![](./media/DxHash.png)

NSArray æ˜¯é•¿åº¦ä¸ºå¤§äº `RS_num` çš„æœ€å° $2^n$ å€¼ï¼Œä¾‹å¦‚ RS æ˜¯ 4 å°ï¼Œåˆ™ NSArray é•¿åº¦ä¸º 8

é€šè¿‡ä¼ªéšæœºæ•°æœºåˆ¶æ¥ä¿è¯åŒä¸€ä¸ª key æœ‰å›ºå®šæœ‰åºä¸”æ— ç¾¡é•¿åº¦çš„æœåŠ¡å™¨åºåˆ—

>  Minimal Disruption: the changed node is either the original or the destination of the remapped keys.

ä¸ºäº†é˜²æ­¢æ— é™é•¿çš„æœåŠ¡å™¨åºåˆ—ä¸€ç›´æ˜ å°„ä¸åˆ°æ´»åŠ¨èŠ‚ç‚¹ï¼ŒDxHash å¯¹æœç´¢çš„æ¬¡æ•°é™åˆ¶åˆ° 8nï¼Œn ä¸º cluster size
$$
P = (\frac{n - 1}{n})^{8n}
$$
å½“ n è¶³å¤Ÿå¤§æ—¶ï¼ŒP æ¥è¿‘ $\dfrac{1}{e^8}$ï¼Œçº¦ä¸º 0.03%ï¼Œä½œè€…è®¤ä¸ºæ¦‚ç‡è¶³å¤Ÿå°

NSArray ä¸å¤Ÿæ—¶è¿›è¡Œä¸¤å€æ‰©å®¹+èŠ‚ç‚¹è¿ç§»

![](./media/DxHash Scaling.png)

å¯ä»¥ä»¥ç±»ä¼¼åˆ‡ç‰‡çš„å½¢å¼æ¥ä¿è¯ä¸ä¼šéœ€è¦èŠ‚ç‚¹è¿ç§»

ã€Œè´¨ç–‘ã€ä½œè€…æ²¡æœ‰è®² NSArray æ‰©å®¹åå‡ºç°çš„å¤§é‡å˜åŒ–çš„é‡æ˜ å°„é—®é¢˜

> When the cluster reaches its maximum capacity and all items in the NSArray are active, DxHash behaves as a classic hash algorithm that maps objects to nodes with a single calculation.

æƒé‡é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹å±‚å®ç°

#### ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å¯¹æ¯”

![å›¾ç‰‡](./media/image13.jpeg)

ä¸åŒèŠ‚ç‚¹æ•°é‡æ—¶å•æ¬¡æŸ¥è¯¢çš„æ—¶é—´ï¼ˆçº³ç§’ï¼‰

![å›¾ç‰‡](./media/image14.jpeg)

* ğ‘‰ï¼šring ä¸­æ¯ä¸ªç‰©ç†èŠ‚ç‚¹å¯¹åº”çš„è™šæ‹ŸèŠ‚ç‚¹ä¸ªæ•°
* ğ‘Šï¼šé›†ç¾¤ä¸­çš„ working èŠ‚ç‚¹æ•°ç›®
* ğ‘ƒï¼šMulti-probe ä¸­çš„æ¢é’ˆ(å“ˆå¸Œ)ä¸ªæ•°
* ğ‘€ï¼šMaglev ä¸­æ¯ä¸ªèŠ‚ç‚¹åœ¨æŸ¥è¯¢è¡¨ä¸­çš„ä½ç½®æ•°
* ğ´ï¼šé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹æ•°(åŒ…æ‹¬ working å’Œé working çš„èŠ‚ç‚¹)

|                | å‡åŒ€æ€§ | æœ€å°åŒ–é‡æ–°æ˜ å°„ | æ—¶é—´å¤æ‚åº¦ | åŠ æƒæ˜ å°„ |
| -------------- | ------ | -------------- | ---------- | -------- |
| å“ˆå¸Œç¯         | è¿˜è¡Œ   | âœ…              | O(logN)    | âœ…        |
| è·³è·ƒä¸€è‡´æ€§å“ˆå¸Œ | âœ…      | âœ…              | O(logN)    | âœ…        |
| Maglev å“ˆå¸Œ    | âœ…      | è¿˜è¡Œ           | O(1)       | âœ…        |

### Rendezvous å“ˆå¸Œ

> 1997

* Rendezvous Hash

ã€Œæ ¸å¿ƒæ€æƒ³ã€

å¦‚æœåªæ˜¯å¯¹æœåŠ¡å™¨ ID è¿›è¡Œå“ˆå¸Œï¼Œé‚£ä¹ˆå½“ä¿®æ”¹æœåŠ¡å™¨çš„æ•°é‡æ—¶ï¼Œæ‰€æœ‰çš„å“ˆå¸Œå€¼éƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚å½“å¯¹ç›®æ ‡æœåŠ¡å™¨çš„é€‰æ‹©å’ŒæœåŠ¡å™¨çš„æ•°é‡æ²¡æœ‰ç›´æ¥å…³ç³»æ—¶ï¼Œå°±å¯ä»¥é¿å…æœåŠ¡å™¨çš„å¢åˆ å¸¦æ¥çš„å½±å“

ã€Œç®—æ³•æ€è·¯ã€

ä¸ºæ¯ä¸ª key ç”Ÿæˆä¸€ä¸ªéšæœºæœ‰åºçš„æœåŠ¡å™¨åˆ—è¡¨ï¼Œå¹¶é€‰æ‹©åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªä½œä¸ºç›®æ ‡æœåŠ¡å™¨

å¦‚æœé€‰æ‹©çš„ç¬¬ä¸€å°æœåŠ¡å™¨ä¸‹çº¿æ—¶ï¼Œåªéœ€è¦å°† key è½¬ç§»åˆ°åˆ—è¡¨ä¸­çš„ç¬¬äºŒå°æœåŠ¡å™¨å¹¶ä½œä¸ºæ–°çš„ç¬¬ä¸€å°æœåŠ¡å™¨å³å¯

1. å¯¹æ¯ä¸ªæœåŠ¡å™¨è®¡ç®— key:rs_id å“ˆå¸Œæ¥ç”Ÿæˆä¸€ç»„æ•´æ•°å“ˆå¸Œå€¼
2. åŸºäºè¯¥å“ˆå¸Œå€¼å¯¹æœåŠ¡å™¨è¿›è¡Œæ’åºï¼Œå¾—åˆ°ä¸€ä¸ªéšæœºæ’åˆ—çš„æœåŠ¡å™¨åˆ—è¡¨

å¯¹äºæœ‰æƒé‡åˆ†é…çš„åœºæ™¯ï¼Œå¯ä»¥åŸºäº w / lnh(x) æ’åºï¼Œh(x) å“ˆå¸ŒèŒƒå›´åœ¨ [0, 1]

**ä¼˜åŠ¿ï¼š**

1. å°†æœåŠ¡å™¨é€‰æ‹©**å’Œæ•°é‡å®Œå…¨è§£ç»‘**ï¼Œå¹¶æä¾›äº†ç¬¬äºŒé€‰æ‹©æœåŠ¡å™¨ï¼Œè§£å†³äº†å“ˆå¸Œçº§è”æ•…éšœè½¬ç§»çš„é—®é¢˜
2. æ²¡æœ‰é¢å¤–çš„**å†…å­˜å­˜å‚¨å¼€é”€**

**é—®é¢˜ï¼š**è°ƒåº¦çš„æ—¶é—´å¼€é”€å’Œæ‰©å®¹å½±å“ç¬¬ä¸€é€‰æ‹©

1. Rendezvous å“ˆå¸Œè¿›è¡Œè°ƒåº¦æ—¶éœ€è¦å¯¹æ‰€æœ‰ RS è¿›è¡Œå“ˆå¸Œè®¡ç®—å¹¶æ’åºï¼Œ**æ—¶é—´å¼€é”€** O(NlogN)ã€‚å®é™…ä¸Šåœ¨å– RS å“ˆå¸Œæ—¶åº”è¯¥å…ˆæ£€æŸ¥å­˜æ´»ï¼Œæ‰€ä»¥åªéœ€è¦ O(N) æŸ¥æ‰¾å“ˆå¸Œå€¼æœ€å¤§çš„ä¸€ä¸ªå³å¯
2. æ‰©å®¹æ—¶æ–°æœåŠ¡å™¨å¯èƒ½æˆä¸ºä¸€äº›å·²æœ‰ key çš„ç¬¬ä¸€é€‰æ‹©ï¼Œæ‰€ä»¥**å¾ˆéš¾ç»´æŠ¤ç¬¬ä¸€é€‰æ‹©çš„ä¸å˜**ã€‚åœ¨åˆ†å¸ƒå¼å­˜å‚¨åœºæ™¯ä¸‹éœ€è¦é‡æ–°æ ¡éªŒæ‰€æœ‰ keyï¼Œä½†åœ¨ç¼“å­˜å’Œè´Ÿè½½å‡è¡¡åœºæ™¯ä¸‹å½±å“å¯ä»¥æ¥å—

ã€Œå˜ä½“ã€

è°ƒåº¦æ—¶é—´ä¼˜åŒ–è‡³ O(logN)ã€‚æŠŠåŸå§‹èŠ‚ç‚¹åˆ†æˆè‹¥å¹²ä¸ªè™šæ‹Ÿç»„ï¼Œè™šæ‹Ÿç»„ä¸€å±‚ä¸€å±‚ç»„æˆä¸€ä¸ªâ€œéª¨æ¶â€ï¼Œç„¶ååœ¨è™šæ‹Ÿç»„ä¸­æŒ‰ç…§ Rendezvous å“ˆå¸Œè®¡ç®—å‡ºæœ€å¤§çš„èŠ‚ç‚¹ï¼Œä»è€Œå¾—åˆ°ä¸‹ä¸€å±‚çš„è™šæ‹Ÿç»„ï¼Œå†åœ¨ä¸‹ä¸€å±‚çš„è™šæ‹Ÿç»„ä¸­æŒ‰åŒæ ·çš„æ–¹æ³•è®¡ç®—ï¼Œç›´åˆ°æ‰¾åˆ°æœ€ä¸‹æ–¹çš„çœŸå®èŠ‚ç‚¹

![å›¾ç‰‡](./media/image15.gif)

ã€Œæ‰©å±•æ€è€ƒã€

å¯¹æ¯ä¸ª RS éƒ½è®¡ç®—å“ˆå¸Œå¹¶æ’åºçš„æ—¶é—´å¼€é”€è¾ƒé«˜ï¼Œå¯ä»¥æ”¹ä¸ºç›´æ¥ä»¥ key å“ˆå¸Œåè¿›è¡Œåˆ‡åˆ†ï¼Œæ¯ MAX_RS_NUM (1024 10bits) ä¸ºä¸€ç»„ï¼Œé¡ºåºåˆ¤æ–­å¯¹åº”çš„ RS æ˜¯å¦å­˜åœ¨å¹¶å­˜æ´»ï¼Œç»´æŠ¤ RS æ•°ç»„ä¸”åœ¨åˆ é™¤æ—¶ä¸å‘å‰ç§»åŠ¨è¡¥é½ã€‚æˆ–æ˜¯æä¾›ç¬¬äºŒç§å“ˆå¸Œç®—æ³•ä½œä¸ºå¤‡é€‰

ç›®çš„ï¼šæä¾›ç¬¬äºŒé€‰æ‹©ï¼Œè€Œéåœ¨ rs_buf ä¸­é¡ºåºçš„å‘åæŸ¥æ‰¾

### Locality Sensitive å“ˆå¸Œ (LSH)

> [LSH ä½ç½®æ•æ„Ÿå“ˆå¸Œå…¥é—¨](https://randorithms.com/2019/09/19/Visual-LSH.html)

![å›¾ç‰‡](./media/image16.png)

ã€Œè¿›é˜¶ã€

Multi-Probe LSH

æ ¸å¿ƒæ€æƒ³æ˜¯ä½¿ç”¨ä¸€ä¸ªä¸¥æ ¼æŒ‘é€‰çš„æ¢æµ‹åºåˆ—æ¥æ£€æµ‹å¤šä¸ªå¯èƒ½åŒ…å«æœ€è¿‘é‚»ç‚¹çš„æ¡¶ï¼Œå¢å¤§æ‰¾åˆ°è¿‘é‚»ç‚¹çš„æ¦‚ç‡ã€‚å®éªŒè¯æ˜ï¼Œåœ¨ä¿è¯ç›¸åŒæ—¶é—´æ•ˆç‡çš„æƒ…å†µä¸‹ï¼Œå‡å°‘äº†ä¸€ä¸ªæ•°é‡çº§çš„å“ˆå¸Œè¡¨æ•°é‡ï¼›åœ¨ä¿è¯ç›¸åŒçš„æœç´¢è´¨é‡çš„æƒ…å†µä¸‹ï¼Œå‡å°‘äº†æŸ¥è¯¢æ—¶é—´ï¼ŒåŒæ—¶å°‘ç”¨äº† 5-8 å€çš„å“ˆå¸Œè¡¨ã€‚ 

ã€Œæ‰©å±•æ€è€ƒã€

LSH åœ¨è¿™é‡Œå¼•å…¥æ˜¯å› ä¸ºå®ƒä¼šå°†ç›¸ä¼¼çš„ key æ›´æœ‰å¯èƒ½è®¡ç®—å‡ºç›¸åŒçš„å“ˆå¸Œç»“æœï¼ˆå³å‘ç”Ÿå“ˆå¸Œç¢°æ’ï¼‰ï¼Œåœ¨ä»¥åœ°ç†ä½ç½®ç­‰è¿›è¡Œåˆ’åˆ†çš„åœºæ™¯ä¸‹å¯èƒ½ä¼šæœ‰ç”¨ï¼Œè¿™é‡Œä¸åšè¯¦ç»†ä»‹ç» 

## äº§å“å®ç°

### Bilibili

LB 1.0

* WRR
  * é—®é¢˜
    * æ— æ³•å¿«é€Ÿæ‘˜é™¤æœ‰é—®é¢˜çš„èŠ‚ç‚¹
    * æ— æ³•å‡è¡¡åç«¯è´Ÿè½½
    * æ— æ³•é™ä½æ€»ä½“å»¶è¿Ÿ

LB 2.0

* åŠ¨æ€æ„ŸçŸ¥çš„ WRR
  * æ–¹å¼
    * åˆ©ç”¨æ¯æ¬¡ RPC è¯·æ±‚è¿”å›çš„ Response **å¤¹å¸¦ CPU ä½¿ç”¨ç‡**
    * æ¯éš”ä¸€æ®µæ—¶é—´æ•´ä½“è°ƒæ•´ä¸€æ¬¡èŠ‚ç‚¹çš„æƒé‡åˆ†æ•°
    
    $$
    peer.score = success\_rate \div (lantency \times cpuUsage)
    $$
  * é—®é¢˜
    * ä¿¡æ¯æ»åå’Œåˆ†å¸ƒå¼å¸¦æ¥çš„ç¾Šç¾¤æ•ˆåº” (VNSWRR æƒ³è§£å†³çš„é—®é¢˜)

LB 3.0

* å¸¦**æ—¶é—´è¡°å‡**çš„ Exponentially Weighted Moving Average å¸¦ç³»æ•°çš„æ»‘åŠ¨å¹³å‡å€¼ï¼Œå®æ—¶æ›´æ–°å»¶è¿Ÿã€æˆåŠŸç‡ç­‰ä¿¡æ¯ï¼Œå°½å¯èƒ½è·å–æœ€æ–°çš„ä¿¡æ¯
* å¼•å…¥ best of two random choices ç®—æ³•ï¼ŒåŠ å…¥**éšæœºæ€§**ï¼Œåœ¨ä¿¡æ¯å»¶è¿Ÿè¾ƒé«˜çš„åœºæ™¯æœ‰æ•ˆæœ
* å¼•å…¥ inflight ä½œä¸ºå‚è€ƒï¼Œ**å¹³è¡¡åèŠ‚ç‚¹æµé‡**ï¼Œinflight è¶Šé«˜è¢«è°ƒåº¦åˆ°çš„æœºä¼šè¶Šå°‘

> The power of two choices in randomized load balancing [Papaer]

è®¡ç®—æƒé‡åˆ†æ•° $success \times metaWeight \div (cpu \times math.Sqrt(lag) \times (inflight + 1))$

* success: å®¢æˆ·ç«¯æˆåŠŸç‡
* metaWeight: åœ¨æœåŠ¡å‘ç°ä¸­è®¾ç½®çš„æƒé‡
* cpu: æœåŠ¡ç«¯æœ€è¿‘ä¸€æ®µæ—¶é—´å†…çš„ cpu ä½¿ç”¨ç‡
* lag: è¯·æ±‚å»¶è¿Ÿ
* inflight: å½“å‰æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°

lag è®¡ç®—

```go
// è·å–&è®¾ç½®ä¸Šæ¬¡æµ‹ç®—çš„æ—¶é—´ç‚¹
stamp := atomic.SwapInt64(&pc.stamp, now)
// è·å¾—æ—¶é—´é—´éš”
td := now - stamp
// è·å¾—æ—¶é—´è¡°å‡ç³»æ•°
w := math.Exp(float64(-td) / float64(tau))
// è·å¾—å»¶è¿Ÿ
lag := now - start
oldLag := atomic.LoadUint64(&pc.lag)
// è®¡ç®—å‡ºå¹³å‡å»¶è¿Ÿ
lag = int64(float64(oldLag) * w + float64(lag) * (1.0 - w))
atomic.StoreUint64(&pc.lag, uint64(lag))
```

best of two ç®—æ³•

```go
a := rand.Intn(len(p.conns))
b := rand.Intn(len(p.conns) - 1)
if b >= a {
    b = b + 1
}
nodeA := p.conns[a]
nodeB := p.conns[b]
if nodeA.load() * nodeB.health() * nodeB.Weight > nodeB.load() * nodeA.health() * nodeA.Weight {
    pick_node = nodeB
} else {
    pick_node = nodeA
}
```

### ç¾å›¢ MGW

* CHash (srcIP)
  * å“ˆå¸Œç¯ï¼šå› ä¸º MGW æ˜¯ä»¥é›†ç¾¤çš„å½¢å¼å­˜åœ¨çš„ï¼Œå½“å¤šä¸ªåº”ç”¨æœåŠ¡å™¨å‘ç”Ÿä¸Šçº¿ä¸‹çº¿æ“ä½œæ—¶ï¼Œåé¦ˆåˆ°ä¸åŒçš„ MGW èŠ‚ç‚¹ä¸Šå°±æœ‰å¯èƒ½ä¼šå‡ºç°é¡ºåºä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå› æ­¤æ— è®ºä¸åŒçš„ MGW èŠ‚ç‚¹äº§ç”Ÿä½•ç§åº”ç”¨æœåŠ¡å™¨ä¸Šä¸‹çº¿é¡ºåºï¼Œéƒ½éœ€è¦ä¿è¯æœ€ç»ˆçš„æ˜ å°„å…³ç³»ä¸€è‡´ï¼Œå› ä¸ºå¦‚æœä¸ä¸€è‡´å°±å¯¼è‡´ç›¸åŒå®¢æˆ·ç«¯çš„è¿æ¥ä¼šè¢«ä¸åŒçš„ MGW èŠ‚ç‚¹è°ƒåº¦åˆ°ä¸åŒçš„åº”ç”¨æœåŠ¡å™¨ä¸Šï¼Œä¹Ÿå°±è¿èƒŒäº†æº IP  Hash è°ƒåº¦å™¨çš„åŸåˆ™
  * åˆ†äº«æ–‡æ¡£æåˆ°äº† Maglev

> RS å¹³æ»‘ä¸‹çº¿ï¼šä¿è¯æ­¤ RS å·²æœ‰è¿æ¥æ­£å¸¸å·¥ä½œï¼Œä½†ä¸ä¼šå¾€ä¸Šé¢è°ƒåº¦æ–°çš„è¿æ¥ã€‚å½“æ‰€æœ‰å·²æœ‰è¿æ¥ç»“æŸä»¥åï¼ŒMGW ä¼šä¸ŠæŠ¥ä¸€ä¸ªç»“æŸçš„çŠ¶æ€ï¼Œç”¨æˆ·å°±å¯ä»¥æ ¹æ®è¿™ä¸ªç»“æŸçš„çŠ¶æ€å¯¹ RS è¿›è¡Œå‡çº§æ“ä½œï¼Œå‡çº§åå†è°ƒç”¨ä¸Šçº¿æ¥å£è®©è¿™ä¸ª RS å™¨è¿›è¡Œæ­£å¸¸çš„æœåŠ¡

> æ•…éšœåˆ‡æ¢ï¼šäº¤æ¢æœºä¾§å…¨éƒ¨ä½¿ç”¨ç‰©ç†æ¥å£å¹¶ä¸”æœåŠ¡å™¨ä¾§å¯¹æ¥å£è¿›è¡Œæ–­ç”µæ—¶ï¼Œäº¤æ¢æœºä¼šç¬é—´å°†æµé‡åˆ‡æ¢åˆ°å…¶ä»–æœºå™¨ä¸Šï¼Œæ˜¯ 0 ä¸¢åŒ…çš„ã€‚ä½†æ˜¯ç½‘å¡é©±åŠ¨æ˜¯è·‘åœ¨ä¸»ç¨‹åºé‡Œé¢çš„ï¼Œå½“ä¸»ç¨‹åºæŒ‚æ‰ä»¥åï¼Œå°±æ— æ³•å†å¯¹ç½‘å£æ‰§è¡Œæ–­ç”µæ“ä½œäº†ï¼Œå› æ­¤ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸»è¿›ç¨‹ä¼šæ•è·å¼‚å¸¸ä¿¡å·ï¼Œå½“å‘ç°å¼‚å¸¸æ—¶å°±å¯¹ç½‘å¡è¿›è¡Œæ–­ç”µæ“ä½œï¼Œåœ¨æ–­ç”µæ“ä½œç»“æŸä»¥åå†ç»§ç»­å°†ä¿¡å·å‘ç»™ç³»ç»Ÿè¿›è¡Œå¤„ç†

> æ¢å¤ä¸æ‰©å®¹ï¼šMGW ä¸Šçº¿æœ‰ä¸€ä¸ªé¢„ä¸Šçº¿çš„ä¸­é—´çŠ¶æ€ï¼Œä¸è®©äº¤æ¢æœºæ„ŸçŸ¥åˆ°è‡ªå·±ä¸Šçº¿ï¼ˆä¸ä¼šæŠŠæµé‡åˆ‡è¿‡æ¥ï¼‰ï¼Œå…ˆè¿›è¡Œ CT åŒæ­¥
>
> 1. ç”±äºé›†ç¾¤ä¸­å¹¶æ²¡æœ‰ä¸€ä¸ªä¸»æ§èŠ‚ç‚¹æ¥ç»´æŠ¤ä¸€ä¸ªå…¨å±€çš„çŠ¶æ€ï¼Œå¦‚æœ request æŠ¥ä¸¢å¤±æˆ–è€… session åŒæ­¥çš„æ•°æ®ä¸¢å¤±çš„è¯ï¼Œé‚£æ–°ä¸Šçº¿èŠ‚ç‚¹å°±æ²¡åŠæ³•ç»´æŠ¤ä¸€ä¸ªå…¨å±€çš„ session çŠ¶æ€ã€‚ä½†æ˜¯è€ƒè™‘åˆ°æ‰€æœ‰èŠ‚ç‚¹éƒ½ç»´æŠ¤ç€ä¸€ä¸ªå…¨å±€çš„ session è¡¨ï¼Œå› æ­¤æ‰€æœ‰èŠ‚ç‚¹æ‹¥æœ‰çš„ session æ•°é‡éƒ½æ˜¯ç›¸åŒçš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨æ‰€æœ‰èŠ‚ç‚¹æ¯æ¬¡åšå®Œæ‰¹é‡åŒæ­¥ä»¥åå‘é€ä¸€ä¸ª finish æ¶ˆæ¯ï¼Œfinish æ¶ˆæ¯ä¸­å¸¦ç€è‡ªå·±æ‹¥æœ‰çš„ session æ•°é‡ã€‚å½“æ–°ä¸Šçº¿èŠ‚ç‚¹æ”¶åˆ° finish æ¶ˆæ¯ä»¥åï¼Œä¾¿ä¼šä»¥è‡ªå·±çš„ session æ•°é‡ä¸ finish ä¸­çš„æ•°é‡åšå¯¹æ¯”ã€‚å½“è¾¾åˆ°æ•°é‡è¦æ±‚ä»¥åï¼Œæ–°ä¸Šçº¿èŠ‚ç‚¹å°±æ§åˆ¶è‡ªå·±è¿›è¡Œä¸Šçº¿æ“ä½œã€‚å¦åˆ™åœ¨ç­‰å¾…ä¸€å®šçš„è¶…æ—¶æ—¶é—´ä»¥åï¼Œé‡æ–°è¿›è¡Œä¸€æ¬¡æ‰¹é‡åŒæ­¥æ“ä½œï¼Œç›´åˆ°è¾¾åˆ°è¦æ±‚ä¸ºæ­¢
> 2. åœ¨è¿›è¡Œæ‰¹é‡åŒæ­¥æ“ä½œæ—¶ï¼Œå¦‚æœå‡ºç°äº†æ–°å»ºè¿æ¥ï¼Œé‚£ä¹ˆæ–°å»ºè¿æ¥å°±ä¸ä¼šé€šè¿‡æ‰¹é‡åŒæ­¥åŒæ­¥åˆ°æ–°ä¸Šçº¿çš„æœºå™¨ä¸Šã€‚å¦‚æœæ–°å»ºè¿æ¥ç‰¹åˆ«å¤šï¼Œå°±ä¼šå¯¼è‡´æ–°ä¸Šçº¿æœºå™¨ä¸€ç›´è¾¾ä¸åˆ°è¦æ±‚ã€‚å› æ­¤ï¼Œéœ€è¦ä¿è¯å¤„äºé¢„ä¸Šçº¿çŠ¶æ€çš„æœºå™¨èƒ½æ¥æ”¶åˆ°å¢é‡åŒæ­¥æ•°æ®ï¼Œå› ä¸ºæ–°å»ºè¿æ¥å¯ä»¥é€šè¿‡å¢é‡åŒæ­¥åŒæ­¥å‡ºæ¥ã€‚é€šè¿‡å¢é‡åŒæ­¥å’Œæ‰¹é‡åŒæ­¥å°±å¯ä»¥ä¿è¯æ–°ä¸Šçº¿æœºå™¨å¯ä»¥æœ€ç»ˆè·å¾—ä¸€ä¸ªå…¨å±€çš„ session è¡¨

### Huawei

* WRR
  * **ä¾æ¬¡**å°†è¯·æ±‚åˆ†å‘ç»™ä¸åŒçš„æœåŠ¡å™¨ã€‚æƒé‡å¤§çš„åç«¯æœåŠ¡å™¨è¢«åˆ†é…çš„æ¦‚ç‡é«˜ï¼Œç›¸åŒæƒé‡çš„æœåŠ¡å™¨å¤„ç†ç›¸åŒæ•°ç›®çš„è¿æ¥æ•°
  * çŸ­è¿æ¥
  * ä¼šè¯ä¿æŒç±»å‹ï¼šæº IP
* W-minConn
  * ç»™æ¯ä¸ªæœåŠ¡å™¨åˆ†é…ä¸åŒçš„æƒé‡ï¼Œä½¿å…¶èƒ½å¤Ÿ**æ¥å—ç›¸åº”æƒå€¼æ•°çš„æœåŠ¡è¯·æ±‚**
  * é•¿è¿æ¥ï¼Œ**å®æ—¶ç›‘æ§**è¿æ¥æ•°å˜åŒ–ï¼Œé™ä½å³°å€¼è´Ÿè½½
  * åªèƒ½ç»Ÿè®¡ LB ä¸ RS ä¹‹é—´çš„è¿æ¥ï¼ŒRS æ•´ä½“è¿æ¥æ•°æ— æ³•è·å–ï¼›æ–°å¢ RS æ—¶å¯èƒ½å¯¼è‡´è¿‡è½½
  * ä¼šè¯ä¿æŒç±»å‹ï¼šæº IP
* sip hash
  * ä¸€è‡´æ€§å“ˆå¸Œ
  * ç”¨æ¥ä¿æŒç”¨æˆ·çŠ¶æ€æˆ–ä¼šè¯çš„åº”ç”¨
  * å·²é»˜è®¤æ”¯æŒæº IP ä¼šè¯ä¿æŒ
* QUIC cid hash
  * ä¼šè¯ä¿æŒç±»å‹ï¼šæº IP

> æ³¨æ„åˆ° DGW é‡Œä¹‹å‰ä¹Ÿæ”¯æŒå…¨è°ƒåº¦ç®—æ³•çš„ stickyï¼Œæœ€åé™åˆ¶äº†åªæœ‰å®Œå…¨éšæœºçš„ sip hash å¯ä»¥æœ‰ stickyã€‚å¯ä»¥æƒ³è±¡ä¾‹å¦‚ WRR è°ƒåº¦æ–°è¿æ¥æ—¶å¹¶ä¸ä¼šè€ƒè™‘ä¹‹å‰æœ‰å¤šå°‘ sticky è¿æ¥ï¼Œè¿™ä¼šå¯¼è‡´æƒé‡ä¹‹é—´çš„å·®å¼‚è¢«æ— é™æ”¾å¤§
>
> ç›¸å½“äºä¸æ˜¯æŒ‰ç…§**è¿æ¥çº§åˆ«**åœ¨è°ƒåº¦ï¼Œè€Œæ˜¯æŒ‰ç…§**å®¢æˆ·ç«¯**çš„çº§åˆ«
>
> ä½†æ˜¯åœ¨ä¸€è‡´æ€§å“ˆå¸Œä¸Šï¼Œä¼šè¯ä¿æŒæ˜¯æœ‰æ„ä¹‰çš„ï¼Œå®ƒä¸ºä¹‹å‰è°ƒåº¦è¿‡çš„æº IP æŒä¹…åŒ–è°ƒåº¦é€‰æ‹©ï¼Œä»è€Œé˜²æ­¢å¦‚æ‰©ç¼©å®¹ã€cid å˜æ›´ç­‰å¸¦æ¥çš„ CT å¤±æ•ˆ

### Aliyun

* RR
* WRR
* W-minConn
* CHash (srcIP, 4-tuple, QUIC ID)

> é˜¿é‡Œäº‘åªåœ¨ CHash éƒ¨åˆ†æåˆ°äº†ä¼šè¯ä¿æŒï¼ˆå“ˆå¸Œç‰¹æ€§è‡ªå¸¦ï¼‰ï¼Œå¹¶æ²¡æœ‰è¯´æ˜æœ‰æä¾›ç±»ä¼¼ sticky çš„ä¿æŒèƒ½åŠ›ã€‚æ‰©ç¼©å®¹æ—¶ä¼šå¯¼è‡´ä¸€éƒ¨åˆ†è¯·æ±‚éœ€è¦é‡æ–°åˆ†é…
>
> è™½ç„¶ NLB å’Œ CLB æ”¯æŒ QUIC ID å“ˆå¸Œï¼Œä½†ä»…æ”¯æŒ Q10ã€Q29 ç‰ˆæœ¬

### Nginx

* WRR é»˜è®¤å’Œå…œåº•ï¼Œå…¶ä»–è°ƒåº¦ç®—æ³•ä¸€ç›´å°è¯•å¤±è´¥ä¼šæ”¹ä¸ºé»˜è®¤ç®—æ³•
  * nginx/src/http/ngx_http_upstream_round_robin.c : ngx_http_upstream_get_peer
* least-connect (W-minConn)
  * nginx/src/http/modules/ngx_http_upstream_least_conn_module.c : ngx_http_upstream_get_least_conn_peer
* W-ip-hash (srcIP)
  * nginx/src/http/modules/ngx_http_upstream_ip_hash_module.c : ngx_http_upstream_get_ip_hash_peer
* W-chash å“ˆå¸Œç¯
  * nginx/src/http/modules/ngx_http_upstream_hash_module.c : ngx_http_upstream_update_chash
* random
  * nginx/src/http/modules/ngx_http_upstream_random_module.c : ngx_http_upstream_peek_random_peer
* Fair Queueing å…¬å¹³é˜Ÿåˆ—ï¼šæ ¹æ®åç«¯èŠ‚ç‚¹æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚

æ³¨æ„ï¼Œæ–‡æ¡£ä¸­è¯´åªæœ‰ ip-hash æœ‰ä¼šè¯ä¿æŒ

> **ä¸ºä»€ä¹ˆ Nginx å®ç°çš„æ‰€æœ‰çš„è°ƒåº¦ç®—æ³•éƒ½æ²¡æœ‰æƒ³è¦ç©ºé—´æ¢æ—¶é—´ï¼Œå…¨éƒ¨éƒ½æ˜¯ O(N) çš„æŸ¥æ‰¾ï¼Ÿ**
> 1. **åŠ¨æ€æƒé‡å’ŒçŠ¶æ€**ï¼š
>   - **æ ¸å¿ƒåŸå› -æƒé‡å¯å˜æ€§ï¼š**Nginx æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´åç«¯æœåŠ¡å™¨çš„æƒé‡ï¼ˆweightï¼‰ã€‚è¿™æ˜¯ç®¡ç†å‘˜è¿›è¡Œç°åº¦å‘å¸ƒã€æµé‡è°ƒæ•´ã€ä¸´æ—¶é™çº§ç­‰æ“ä½œçš„æ ¸å¿ƒæ‰‹æ®µã€‚è¿™ä¼šå¯¼è‡´ **O(1) é¢„è®¡ç®—å¤±æ•ˆã€‚**åœ¨æƒé‡é¢‘ç¹è°ƒæ•´ï¼ˆå³ä½¿æ˜¯å¶å°”ï¼‰æˆ–æœåŠ¡å™¨æ•°é‡ï¼ˆNï¼‰å¾ˆå¤§çš„åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªé‡æ–°è®¡ç®—çš„æˆæœ¬ï¼ˆO(N) æˆ– O(NlogN) ç”šè‡³æ›´é«˜ï¼‰ä¼šå˜å¾—éå¸¸é«˜ï¼Œå¹¶ä¸”å¯èƒ½å‘ç”Ÿåœ¨å¤„ç†è¯·æ±‚çš„å…³é”®è·¯å¾„ä¸Šï¼Œé€ æˆå»¶è¿ŸæŠ–åŠ¨
>   - **çŠ¶æ€æ„ŸçŸ¥ç®—æ³•**ï¼šåƒ least_connï¼ˆæœ€å°è¿æ¥æ•°ï¼‰å’Œ least_timeï¼ˆæœ€çŸ­å“åº”æ—¶é—´ï¼‰è¿™ç±»ç®—æ³•ï¼Œå…¶é€‰æ‹©æ ‡å‡†å®Œå…¨ä¾èµ–äºåç«¯æœåŠ¡å™¨çš„å®æ—¶çŠ¶æ€ï¼Œæ— æ³•é¢„å…ˆè®¡ç®—å‡ºä¸€ä¸ªå›ºå®šçš„è°ƒåº¦åºåˆ—
> 2. **N é€šå¸¸è¾ƒå°**ï¼š
>   - **ç°å®é›†ç¾¤è§„æ¨¡**ï¼šåœ¨ç»å¤§å¤šæ•°å®é™…éƒ¨ç½²ä¸­ï¼Œä¸€ä¸ª upstream å—ï¼ˆåç«¯æœåŠ¡å™¨ç»„ï¼‰åŒ…å«çš„åç«¯æœåŠ¡å™¨æ•°é‡ N é€šå¸¸æ˜¯æœ‰é™çš„ï¼Œä¸€èˆ¬åœ¨å‡ åå°åˆ°ä¸€ä¸¤ç™¾å°çš„é‡çº§ã€‚å¯¹äºè¿™ä¸ªæ•°é‡çº§ï¼ŒO(N) çš„éå†åœ¨ç°ä»£ CPU ä¸Šå¯èƒ½æ˜¯çº³ç§’åˆ°å¾®ç§’çº§åˆ«ã€‚**O(1) ä¼˜åŠ¿ä¸æ˜æ˜¾**ï¼ŒO(1)  ç®—æ³•ï¼ˆå¦‚å“ˆå¸Œè¡¨æŸ¥æ‰¾ï¼‰å¸¦æ¥çš„ç»å¯¹æ—¶é—´èŠ‚çœéå¸¸æœ‰é™ï¼Œç”šè‡³å¯èƒ½å› ä¸ºå“ˆå¸Œè®¡ç®—ã€å¯èƒ½çš„å“ˆå¸Œå†²çªå¤„ç†ã€ç¼“å­˜ä¸å‹å¥½ç­‰åŸå› ï¼Œå…¶å¸¸æ•°å› å­æ¯”ç®€å•çš„é¡ºåºéå†æ›´å¤§ï¼Œå¯¼è‡´å®é™…æ€§èƒ½åè€Œä¸å¦‚  O(N) éå†ã€‚é¡ºåºéå†å¯¹ CPU ç¼“å­˜éå¸¸å‹å¥½ï¼ˆçº¿æ€§è®¿é—®å†…å­˜ï¼‰
> 3. **å†…å­˜æ•ˆç‡**ï¼š
>   - **é¢„è®¡ç®—åºåˆ—çš„å†…å­˜å¼€é”€**ï¼šé¢„ç”Ÿæˆå®Œæ•´çš„è½®è¯¢åºåˆ—ï¼ˆå°¤å…¶æ˜¯è€ƒè™‘æƒé‡æ—¶ï¼‰éœ€è¦é¢å¤–çš„ O(S) å†…å­˜ç©ºé—´ï¼Œå…¶ä¸­ S æ˜¯æ‰€æœ‰æœåŠ¡å™¨æƒé‡ä¹‹å’Œ
>   - **Nginx çš„å†…å­˜ä¼˜åŒ–å€¾å‘**ï¼šNginx ä»¥é«˜æ€§èƒ½å’Œä½å†…å­˜æ¶ˆè€—è‘—ç§°
> 4. **ç®—æ³•ç®€å•æ€§ä¸é²æ£’æ€§**ï¼š
>   - **å®ç°ç®€å•**ï¼šO(N) çš„éå†ç®—æ³•å®ç°èµ·æ¥ç›¸å¯¹ç®€å•ã€æ¸…æ™°ï¼Œä»£ç æ˜“äºç†è§£å’Œç»´æŠ¤
>   - **é²æ£’æ€§å¥½**ï¼šç®€å•çš„é¡ºåºéå†å¯¹åç«¯æœåŠ¡å™¨çš„åŠ¨æ€å˜åŒ–ï¼ˆå¢ã€åˆ ã€æƒé‡æ”¹ã€çŠ¶æ€å˜ï¼‰å“åº”ç›´æ¥ä¸”è‡ªç„¶ã€‚é¢„è®¡ç®—åºåˆ—åœ¨åŠ¨æ€å˜åŒ–æ—¶éœ€è¦å¤æ‚çš„æ›´æ–°æˆ–å¤±æ•ˆæœºåˆ¶ï¼Œå®¹æ˜“å¼•å…¥è¾¹ç•Œæ¡ä»¶é”™è¯¯
>  
> æ€»ç»“:
> Nginx åœ¨æ ¸å¿ƒè´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆè½®è¯¢ã€åŠ æƒè½®è¯¢ã€æœ€å°è¿æ¥ã€æœ€çŸ­æ—¶é—´ï¼‰ä¸­é€‰æ‹© O(N) çš„è°ƒåº¦æŸ¥æ‰¾ç­–ç•¥ï¼Œæ˜¯ç»è¿‡æ·±æ€ç†Ÿè™‘çš„æƒè¡¡ï¼š
>   - **æ ¸å¿ƒåˆ¶çº¦å› ç´ **ï¼šæ”¯æŒåŠ¨æ€æƒé‡å’Œå®æ—¶çŠ¶æ€æ„ŸçŸ¥ä½¿å¾— O(1) çš„é¢„è®¡ç®—åºåˆ—æ–¹æ¡ˆåœ¨åŠ¨æ€æ›´æ–°æ—¶æˆæœ¬è¿‡é«˜æˆ–ä¸é€‚ç”¨
>   - **ç°å®å¯è¡Œæ€§**ï¼šå¯¹äºå…¸å‹çš„åç«¯æœåŠ¡å™¨æ•°é‡ (N)ï¼ŒO(N) éå†çš„ç»å¯¹æ—¶é—´å¼€é”€éå¸¸ä½ï¼Œåœ¨ç°ä»£ CPU ä¸Šå®Œå…¨å¯ä»¥æ¥å—
>   - **èµ„æºä¼˜åŒ–**ï¼šé¿å…äº†ä¸º O(1) é€‰æ‹©è€Œé¢„è®¡ç®—åºåˆ—æˆ–ç»´æŠ¤å¤§å‹å“ˆå¸Œè¡¨å¸¦æ¥çš„æ˜¾è‘—é¢å¤–å†…å­˜æ¶ˆè€—
>   - **è®¾è®¡å“²å­¦**ï¼šç¬¦åˆ Nginx è¿½æ±‚ç®€å•ã€é«˜æ•ˆï¼ˆå°¤å…¶æ˜¯å†…å­˜æ•ˆç‡ï¼‰å’Œé²æ£’æ€§çš„è®¾è®¡åŸåˆ™
> å› æ­¤ï¼Œå°½ç®¡åœ¨çº¯ç®—æ³•ç†è®ºä¸Šçœ‹ O(N) ä¸å¦‚ O(1) æˆ– O(log N)ï¼Œä½†åœ¨ Nginx è´Ÿè½½å‡è¡¡çš„å…·ä½“ä¸Šä¸‹æ–‡ã€çº¦æŸæ¡ä»¶ï¼ˆåŠ¨æ€æƒé‡ã€çŠ¶æ€æ„ŸçŸ¥ï¼‰å’Œå…¸å‹éƒ¨ç½²è§„æ¨¡ä¸‹ï¼ŒO(N) çš„éå†æ˜¯ä¸€ä¸ªéå¸¸åˆç†ä¸”é«˜æ•ˆçš„å·¥ç¨‹é€‰æ‹©ã€‚å®ƒç”¨å¾®å°çš„ã€å¯æ¥å—çš„ CPU æ—¶é—´å¢é‡ï¼Œæ¢å–äº†ç®—æ³•çš„çµæ´»æ€§ã€ä½å†…å­˜å¼€é”€å’Œå¯¹åŠ¨æ€å˜åŒ–çš„è‡ªç„¶æ”¯æŒ

**ã€ŒSWRRã€**

```c
# nginx/src/http/ngx_http_upstream_round_robin.c : ngx_http_upstream_get_peer
for (peer = rrp->peers->peer, i = 0;
     peer;
     peer = peer->next, i++)
{
    if (peer->down) {
        continue;
    }


    if (peer->max_fails
        && peer->fails >= peer->max_fails
        && now - peer->checked <= peer->fail_timeout)
    {
        continue;
    }


    if (peer->max_conns && peer->conns >= peer->max_conns) {
        continue;
    }


    peer->current_weight += peer->effective_weight;
    total += peer->effective_weight;


    if (peer->effective_weight < peer->weight) {
        peer->effective_weight++;
    }


    if (best == NULL || peer->current_weight > best->current_weight) {
        best = peer;
        p = i;
    }
}
best->current_weight -= total;
return best;
```

**é—®é¢˜ï¼š**

1. å¯ä»¥çœ‹åˆ° Nginx ä»ç„¶åœ¨ä½¿ç”¨ SWRR ç®—æ³•ï¼Œç›¸æ¯”äº VNSWRR å®ƒçš„ä¼˜åŠ¿åœ¨å“ªé‡Œï¼Ÿ
2. æ³¨æ„åˆ° 24-26 è¡Œï¼Œæ˜¯å¦æ„å‘³ç€åç»­å¯ä»¥é…ç½®çƒ­æ›´æ–°æƒé‡å¹¶åŠ¨æ€ç¼“æ…¢çš„æ›´æ–°æœ‰æ•ˆæƒé‡ï¼Ÿ

weight: é…ç½®æ–‡ä»¶ä¸­çš„æƒé‡

effective_weight: åŠ¨æ€çš„æœ‰æ•ˆæƒé‡ï¼Œåˆå§‹åŒ–ä¸º weightã€‚å½“å’Œ RS é€šä¿¡å‘ç”Ÿé”™è¯¯æ—¶å‡å°ï¼Œåç»­é€æ­¥æ¢å¤

 

ã€Œæ‰©å±•æ€è€ƒã€åœ¨ç³»ç»Ÿåˆå§‹æ—¶ï¼Œé€šè¿‡å°†æ‰€æœ‰ effective_weight åˆå§‹åŒ–ä¸º 1 æ¥æ”¾å¤§éšæœºæ•ˆæœï¼ˆé€‰ best æ—¶ä¹Ÿå¯ä»¥æ·»åŠ éšæœºæ•°åˆ¤æ–­ peer->current_weight == best->current_weight æ—¶æ˜¯å¦è¦æ›¿æ¢ best = peerï¼‰

ä½†æ˜¯å‚è€ƒ `ngx_http_upstream_init_round_robin` åˆå§‹åŒ–ä¸­çš„èµ‹å€¼ï¼Œéƒ½ä¼šæœ‰ peer.weight = peer.effective_weight = server.weight

 

**ã€ŒW-chashã€**

åˆ›å»ºäº† weight * 160 ä¸ªå½±å­èŠ‚ç‚¹ï¼Œæ ¹æ®å“ˆå¸Œå€¼æ’åº

æŠ½ç¦»ç‰ˆå®ç°å¯å‚è€ƒ [libchash/chash.c](https://github.com/dgryski/libchash/blob/master/chash.c)

 

**ã€Œip-hashã€**

å¯¹ IP åœ°å€å“ˆå¸Œåå–æ¨¡ RS æ€»æƒé‡ï¼Œç„¶åä¾æ¬¡å‡æ‰æ¯ä¸€ä¸ª RS çš„æƒé‡çœ‹è½åœ¨å“ªä¸ª RS é‡Œï¼Œä»è€Œå°†æƒé‡ä½œä¸ºå½±å“å› ç´ æ”¾å…¥ç›´æ¥å“ˆå¸Œ

 

**ã€Œleast-connectã€**

é¡ºåºéå† O(N) æŸ¥æ‰¾è¿æ¥æ•°æœ€å°çš„ RS

å‡ºç°ç›¸åŒçš„æœ€å°è¿æ¥æ•°æ—¶ï¼Œå›é€€åˆ° SWRR è¿›è¡Œé€‰æ‹©

æ¯”è¾ƒè¿æ¥æ•°æ—¶ï¼Œå› ä¸ºæ˜¯éå†çš„ä¸¤ä¸¤æ¯”è¾ƒï¼Œå¯ä»¥é€šè¿‡ peer->conns * best->weight < best->conns * peer->weight æ¥è€ƒè™‘æƒé‡

 

### çˆ±å¥‡è‰º DPVS

![å›¾ç‰‡](./media/image17.png)
![å›¾ç‰‡](./media/image18.png)

> [Cooper](https://cooper.didichuxing.com/docs2/document/2202486120863) from æ™“å®‡

### Cloudflare Unimog

è‡ªç ”ç¡¬ä»¶æœåŠ¡å™¨ï¼ŒSDN æ¶æ„

å¯ä»¥æ ¹æ® RS çš„è´Ÿè½½åŠ¨æ€è°ƒæ•´è¿æ¥æ•°é‡

æœºæˆ¿å†…æ‰€æœ‰æœºå™¨éƒ½å®‰è£…äº†å››å±‚ LBï¼Œè·¯ç”±å™¨æ— è®ºæŠŠåŒ…å‘ç»™å“ªå°éƒ½ä¼šè½¬å‘åˆ°æ­£ç¡®çš„ RS ä¸Š

ä¼˜åŠ¿ï¼š

1. LB ä¸éœ€è¦åšå®¹é‡è§„åˆ’
2. æœ€å¤§é™åº¦é˜² DDoS
3. è¿ç»´æ¶æ„ç®€å•ï¼Œæ‰€æœ‰æœºå™¨éƒ½ä¸€æ ·

LB ä¹‹é—´ä¸åŒæ­¥çŠ¶æ€ï¼Œè¿æ¥ä¿æŒæ–¹æ¡ˆç±»ä¼¼ Maglevï¼šæ‰€æœ‰ LB è‡ªå·±å†³å®šï¼Œä½†ä¿è¯å¯¹äºç›¸åŒçš„ 4-tuple ä¼šè½¬å‘ç›¸åŒçš„ RSã€‚æ‰€æœ‰ LB éƒ½æ¥æ”¶ç”±æ§åˆ¶å¹³é¢ç»Ÿä¸€ä¸‹å‘çš„è½¬å‘è¡¨ï¼Œé€šè¿‡ 4-tuple-hash æŸ¥è¡¨ã€‚è½¬å‘è¡¨ä¸­æ¯ä¸ª RS å¯ä»¥è®¾ç½®å¤šä¸ª bucketï¼ˆæƒé‡ï¼‰ï¼ŒRS ä¸‹çº¿åªä¿®æ”¹å¯¹åº” bucket

![å›¾ç‰‡](./media/image19.png)

ç”±äºæ²¡æœ‰ ctï¼Œå®ƒé€šè¿‡å¤‡ä»½è½¬å‘è¡¨ (second hop) æ–¹å¼æ¥ç»§ç»­å…ˆå‰çš„è½¬å‘ã€‚å½“ä¸€ä¸ª RS æœºå™¨æ”¶åˆ°åŒ…æ—¶ï¼Œå…ˆæ£€æŸ¥å½“å‰æœºå™¨æœ‰æ²¡æœ‰è¿™ä¸ª TCP socketï¼Œå¦‚æœæ²¡æœ‰å°±è½¬å‘åˆ° second hop

> å…³äºå¤‡ä»½è½¬å‘è¡¨å­˜å¤šä¹…çš„é—®é¢˜ï¼Œæ–‡ç« ä½œè€… kawabangga é—®äº† cfï¼Œè§£é‡Šæ˜¯ï¼š
>   - åˆ é™¤å®ä¾‹åœ¨ Cloudflare ä¸å¤ªå¸¸è§ï¼Œæ›´å¸¸è§çš„æ˜¯çŸ­æš‚ç§»é™¤ï¼Œrebootï¼Œç„¶åå›åˆ°é›†ç¾¤ï¼Œå‡ ä¹æ‰€æœ‰çš„æœºå™¨æ¯æœˆéƒ½ä¼šé‡å¯ä¸€æ¬¡ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªè¿æ¥åœ¨ 24 å°æ—¶ä¹‹å†…éƒ½æœ‰ 1/30 çš„å‡ ç‡è¢« reset
>   - å¦‚æœè¦ç§»é™¤çš„è¯ï¼Œå¦‚æ–‡ä¸­æ‰€è¯´ï¼Œä¼šè¿›å…¥åˆ° drain stateï¼Œåœ¨å¤‡è¡¨ä¸­ï¼Œè¿™ä¸ªçŠ¶æ€åªä¼šç»´æŒå‡ åˆ†é’Ÿ
>   - ç®€å•æ¥è¯´ï¼Œè¿æ¥å¯ä»¥å½’ä¸ºä¸¤ç±»ï¼šshort-lived å’Œ long-livedã€‚å‡ åˆ†é’Ÿè¶³å¤Ÿæ‰€æœ‰ short-lived  è¿æ¥ç»“æŸäº†ï¼Œå‰©ä¸‹çš„éƒ½æ˜¯ long-livedï¼Œå¦‚æœ drain çŠ¶æ€  30minï¼Œå¯èƒ½ä¼šæœ‰éƒ¨åˆ†è¿æ¥æ­£å¸¸ç»“æŸï¼Œä½†æ˜¯ä¸ä¼šå¾ˆå¤šï¼Œå¤§éƒ¨åˆ†è¶…è¿‡å‡ åˆ†é’Ÿçš„è¿æ¥ä¼šå­˜åœ¨æ•°å°æ—¶ç”šè‡³æ•°å¤©ï¼Œç»§ç»­ç­‰å¾…ä¹Ÿä¸ä¼šå¸¦æ¥æ›´å¤šæ˜¾è‘—å—ç›Šï¼Œä½†æ˜¯ä¼šè®©æ“ä½œæ•ˆç‡å¤§å¤§é™ä½ï¼Œæ‰€ä»¥åªç­‰å¾…å‡ åˆ†é’Ÿ

### GitHub GLB

![å›¾ç‰‡](./media/image20.jpeg)

ã€Œè½¬å‘è¿‡ç¨‹ã€

1. æ ¹æ® hash æŸ¥æ‰¾è½¬å‘è¡¨ï¼Œæ‰¾åˆ°å¯¹åº”çš„ 2 ä¸ª RSï¼Œä¸€ä¸ªæ˜¯ä¸» RS ä¸€ä¸ªæ˜¯å¤‡ RSï¼Œç„¶åè½¬å‘åˆ°ä¸» RS
2. ä¸» RS æ”¶åˆ°åŒ…ä¹‹åï¼Œæ£€æŸ¥è¿™ä¸ªåŒ…æ˜¯ä¸æ˜¯å±äºè‡ªå·±æœºå™¨ä¸Šçš„è¿æ¥ï¼Œå¦‚æœæ˜¯ï¼Œå°±äº¤ç»™åè®®æ ˆå¤„ç†ï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±è½¬å‘åˆ°å¤‡ RSï¼ˆå¤‡ RS çš„åœ°å€è®°å½•åœ¨ GLB å‘è¿‡æ¥çš„åŒ…ä¸­ï¼‰

![å›¾ç‰‡](./media/image21.jpeg)

ã€Œè½¬å‘è¡¨ã€

* åœ¨ RS ä¿®æ”¹çš„æ—¶å€™ï¼Œåªæœ‰å˜åŒ–çš„ RS åœ¨è¡¨ä¸­ä¼šä¿®æ”¹ï¼Œæ²¡æœ‰å˜åŒ–çš„ RS åœ¨è¡¨ä¸­çš„ä½ç½®ä¸å˜ã€‚å³ä¸èƒ½å¯¹æ•´ä¸ªè¡¨å®Œå…¨é‡æ–° hash
* è¡¨çš„ç”Ÿæˆä¸ä¾èµ–å¤–éƒ¨çš„çŠ¶æ€
* æ¯ä¸€è¡Œçš„ä¸¤ä¸ª RS ä¸åº”è¯¥ç›¸åŒ
* æ‰€æœ‰ RS åœ¨è¡¨ä¸­å‡ºç°çš„æ¬¡æ•°åº”è¯¥æ˜¯å¤§è‡´ç›¸åŒçš„ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰

å®ç°æ–¹å¼æ˜¯ç±»ä¼¼ Rendezvous hashingï¼šå¯¹äºæ¯ä¸€è¡Œï¼Œå°†è¡Œå· + RS IP è¿›è¡Œ Hash å¾—åˆ°ä¸€ä¸ªæ•°å­—ï¼Œä½œä¸ºâ€œåˆ†æ•°â€ï¼Œæ‰€æœ‰çš„ RS åœ¨è¿™ä¸€è¡ŒæŒ‰ç…§åˆ†æ•°æ’åºï¼Œå–å‰ä¸¤åï¼Œä½œä¸ºä¸» RS å’Œ å¤‡ RS æ”¾åˆ°è¡¨ä¸­ã€‚ç„¶åæŒ‰ç…§ä»¥ä¸‹çš„å››ä¸ªæ¡ä»¶æ¥åˆ†æï¼š

* å¦‚æœæ·»åŠ  RSï¼Œé‚£ä¹ˆåªæœ‰æ–° RS æ’åç¬¬ä¸€çš„ç›¸å…³çš„è¡Œéœ€è¦ä¿®æ”¹ï¼Œå…¶ä»–çš„è¡Œä¸ä¼šæ”¹å˜
* ç”Ÿæˆè¿™ä¸ªè¡¨åªä¼šä¾èµ– RS çš„ IP
* æ¯ä¸€è¡Œçš„ä¸¤ä¸ª RS ä¸å¯èƒ½ç›¸åŒï¼Œå› ä¸ºå–çš„å‰ä¸¤å
* Hash ç®—æ³•å¯ä»¥ä¿è¯æ¯ä¸€ä¸ª IP å½“ç¬¬ä¸€åçš„æ¦‚ç‡æ˜¯å‡ ä¹ä¸€æ ·çš„

ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨æƒ³è¦åˆ é™¤ RS çš„æ—¶å€™ï¼Œè¦äº¤æ¢ä¸» RS å’Œ å¤‡ RS çš„ä½ç½®ï¼Œè¿™æ ·ï¼Œä¸» RS  æ¢åˆ°å¤‡å°±ä¸ä¼šæœ‰æ–°è¿æ¥äº†ï¼Œç­‰æ®‹ç•™çš„è¿æ¥éƒ½ç»“æŸï¼Œå°±å¯ä»¥ä¸‹çº¿äº†ï¼›åœ¨æ·»åŠ  RS çš„æ—¶å€™ï¼Œæ¯æ¬¡åªèƒ½æ·»åŠ ä¸€ä¸ªï¼Œå› ä¸ºå¦‚æœä¸€æ¬¡æ·»åŠ ä¸¤ä¸ªï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ª RS å¦‚æœå‡ºç°åœ¨åŒä¸€è¡Œçš„ç¬¬ä¸€åå’Œç¬¬äºŒåï¼Œä¹‹å‰çš„ RS å°±ä¼šæ²¡æ¥å¾—åŠ drain å°±æ²¡äº†ï¼Œé‚£ä¹ˆä¹‹å‰çš„ RS çš„è¿æ¥éƒ½ä¼šæ–­æ‰

 

**ä¼˜åŠ¿ï¼š**

1. æä¾›ç¬¬äºŒé€‰æ‹©
2. ä¸éœ€è¦ä¿å­˜æ•°æ®
3. GLB å®ä¾‹å¯ä»¥å’Œ RS åŒæ—¶åšå˜åŒ–

**é—®é¢˜ï¼š**

1. è¦åŠ¨ RS

 

### Google Maglev

DSR è½¬å‘æ¨¡å¼ï¼ŒMaglev ä¸ä¼šåš NATï¼Œé€šè¿‡ GRE å°†äºŒå±‚åŒ…å°è£…è¿› IP åŒ…é‡Œï¼ˆéœ€è¦ MSS é¢„ç•™ç©ºé—´ï¼‰

![å›¾ç‰‡](./media/image22.png)

ä¸Šå›¾æ˜¯åŒ…çš„è½¬å‘æµç¨‹ï¼Œç»¿è‰²çš„æ˜¯åŒ…ç»è¿‡çš„è·¯å¾„

 

## Reference

> éƒ¨åˆ†å‚è€ƒ

* [ä¸€è‡´æ€§å“ˆå¸Œç®—æ³• - é—®é¢˜çš„æå‡º - å“ˆå¸Œç¯æ³• - è·³è·ƒä¸€è‡´æ€§å“ˆå¸Œæ³• - Maglev ä¸€è‡´æ€§å“ˆå¸Œæ³•](https://writings.sh/post/consistent-hashing-algorithms-part-1-the-problem-and-the-concept)
* [Consistent Hashing: Algorithmic Tradeoffs ä¸€è‡´æ€§å“ˆå¸Œï¼šç®—æ³•æƒè¡¡](https://dgryski.medium.com/consistent-hashing-algorithmic-tradeoffs-ef6b8e2fcae8#890d) å’Œ [libchash](https://github.com/dgryski/libchash)
* [ä¸€è‡´æ€§å“ˆå¸Œæ±‡æ€»](https://developer.aliyun.com/article/1629452)
* [ketama (æºç )](https://github.com/RJ/ketama)
* [Jump Consistent Hash ç®—æ³•](https://luyuhuang.tech/2021/06/13/jump-consistent-hash.html)
* [A Fast, Minimal Memory, Consistent Hash Algorithm (è®ºæ–‡)](https://arxiv.org/abs/1406.2294)
* [Multi-Probe Consistent Hashing (è®ºæ–‡)](https://arxiv.org/abs/1505.00062)
* [Maglev: A Fast and Reliable Software Network Load Balancer (è®ºæ–‡)](https://research.google/pubs/maglev-a-fast-and-reliable-software-network-load-balancer/)
* [AnchorHash: A Scalable Consistent Hash (è®ºæ–‡)](https://arxiv.org/abs/1812.09674)
* [AnchorHash (æºç )](https://github.com/anchorhash/cpp-anchorhash)
* [DxHash: A Scalable Consistent Hashing Based on the Pseudo-Random Sequence (è®ºæ–‡)](https://arxiv.org/pdf/2107.07930)
* [Rendezvous hashing ç®—æ³•ä»‹ç»](https://cloud.tencent.com/developer/article/2327298)
* [Rendezvous Hashing Explained (åŸæ–‡)](https://randorithms.com/2020/12/26/rendezvous-hashing.html)
* [Rendezvous Hashing æºç å’Œå®éªŒå¯¹æ¯”](https://github.com/clohfink/RendezvousHash)
* [Rendezvous Hashing åŸºäºéª¨æ¶çš„åˆ†å±‚ä¼šåˆæ•£åˆ— O(logN) ä¼˜åŒ–](https://en.wikipedia.org/wiki/Rendezvous_hashing#O(log_n)_running_time_via_skeleton-based_hierarchical_rendezvous_hashing)
* [LSH ä½ç½®æ•æ„Ÿå“ˆå¸Œå…¥é—¨](https://randorithms.com/2019/09/19/Visual-LSH.html)
* [Consistently Faster: A survey and fair comparison of consistent hashing algorithms](https://amosbrocco.ch/pubs/paper03.pdf)
* [å››å±‚è´Ÿè½½å‡è¡¡æ¼«è°ˆ](https://www.kawabangga.com/posts/5301)
* [ã€ŒBilibiliã€RPC è´Ÿè½½å‡è¡¡ç®—æ³•çš„æ¼”è¿›ä¹‹è·¯](https://mp.weixin.qq.com/s/1U_XSqaGCcbsmGpW2DoVHQ)
* [ã€Œç¾å›¢ã€MGWâ€”â€”ç¾å›¢ç‚¹è¯„é«˜æ€§èƒ½å››å±‚è´Ÿè½½å‡è¡¡](https://tech.meituan.com/2017/01/05/mgw.html)
* [ã€Œåä¸ºäº‘ã€é…ç½®ä¼šè¯ä¿æŒæå‡è®¿é—®æ•ˆç‡](https://support.huaweicloud.com/usermanual-elb/elb_ug_jt_0004.html)
* [ã€Œé˜¿é‡Œäº‘ã€è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•ä»‹ç»](https://www.alibabacloud.com/help/zh/slb/product-overview/introduction-to-load-balancing-scheduling-algorithm)
* [ã€ŒNginxã€Nginx æºç ](https://github.com/nginx/nginx) å’Œ [Nginx SWRR Commit](https://github.com/nginx/nginx/commit/52327e0627f49dbda1e8db695e63a4b0)
* [ã€ŒLVSã€LVS WRR](https://kb.linuxvirtualserver.org/wiki/Weighted_Round-Robin_Scheduling)
* [ã€Œçˆ±å¥‡è‰ºã€DPVS (æºç )](https://github.com/iqiyi/dpvs)
* [ã€ŒCloudflareã€Unimog - Cloudflareâ€™s edge load balancer](https://blog.cloudflare.com/unimog-cloudflares-edge-load-balancer/)
* [ã€ŒGitHubã€GLB: GitHubâ€™s open source load balancer](https://github.blog/engineering/glb-director-open-source-load-balancer/) å’Œ [GLB æºç ](https://github.com/github/glb-director)
* [ã€ŒGoogleã€å››å±‚è´Ÿè½½å‡è¡¡åˆ†æï¼šGoogle Maglev](https://www.kawabangga.com/posts/5759)
